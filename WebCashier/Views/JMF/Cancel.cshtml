@{
    ViewData["Title"] = "Payment Cancelled";
}

<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>@ViewData["Title"]</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/crypto-js/4.1.1/crypto-js.min.js"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Roboto', 'Oxygen', 'Ubuntu', 'Cantarell', sans-serif; background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%); min-height: 100vh; display: flex; align-items: center; justify-content: center; padding: 20px; }
        .container { max-width: 600px; width: 100%; }
        .error-card { background: white; border-radius: 12px; box-shadow: 0 20px 60px rgba(0,0,0,0.3); overflow: hidden; }
        .error-header { background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%); color: white; padding: 40px 20px; text-align: center; }
        .error-icon { width: 80px; height: 80px; margin: 0 auto 20px; background: rgba(255,255,255,0.2); border-radius: 50%; display: flex; align-items: center; justify-content: center; animation: slideIn 0.6s ease-out; }
        .error-icon svg { width: 45px; height: 45px; stroke: white; stroke-width: 2; }
        .error-header h1 { font-size: 28px; margin-bottom: 8px; font-weight: 600; }
        .error-header p { font-size: 14px; opacity: 0.9; }
        .error-body { padding: 40px 30px; }
        .action-buttons { display: flex; gap: 12px; margin-top: 30px; }
        .btn { flex: 1; padding: 12px 20px; border: none; border-radius: 6px; font-size: 14px; font-weight: 600; cursor: pointer; text-decoration: none; text-align: center; transition: all 0.2s; }
        .btn-primary { background: #f5576c; color: white; }
        .btn-primary:hover { background: #e63946; }
        .btn-secondary { background: #f0f0f0; color: #333; }
        .btn-secondary:hover { background: #e0e0e0; }
        .btn:disabled { opacity: 0.6; cursor: not-allowed; }
        .info-text { color: #666; font-size: 14px; margin-bottom: 20px; line-height: 1.6; }
        .status-section { margin-top: 30px; padding-top: 30px; border-top: 1px solid #eee; }
        .status-title { font-size: 16px; font-weight: 600; color: #333; margin-bottom: 15px; }
        .status-box { background: #f9f9f9; border: 1px solid #e0e0e0; border-radius: 8px; padding: 15px; margin-bottom: 15px; }
        .status-item { display: flex; justify-content: space-between; padding: 8px 0; font-size: 13px; border-bottom: 1px solid #eee; }
        .status-item:last-child { border-bottom: none; }
        .status-label { font-weight: 600; color: #666; }
        .status-value { color: #333; word-break: break-all; }
        .error-box { background: #fee; border: 1px solid #fcc; color: #c33; padding: 12px; border-radius: 6px; margin-bottom: 15px; font-size: 13px; }
        .loading { text-align: center; color: #666; font-size: 13px; }
        .spinner { display: inline-block; width: 16px; height: 16px; border: 2px solid #f3f3f3; border-top: 2px solid #f5576c; border-radius: 50%; animation: spin 1s linear infinite; margin-right: 8px; vertical-align: middle; }
        @@keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        @@keyframes slideIn { from { transform: translateY(-20px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }
        @@media (max-width: 600px) {
            .error-header { padding: 30px 15px; }
            .error-body { padding: 25px 15px; }
            .error-header h1 { font-size: 24px; }
            .action-buttons { flex-direction: column; }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="error-card">
            <div class="error-header">
                <div class="error-icon">
                    <svg viewBox="0 0 24 24" fill="none"><path d="M6 18L18 6M6 6l12 12" stroke-linecap="round" stroke-linejoin="round"/></svg>
                </div>
                <h1>Payment Cancelled</h1>
                <p>Your payment session has been cancelled.</p>
            </div>
            <div class="error-body">
                <p class="info-text">
                    Your payment was not processed. If this was unintentional or if you'd like to try again, 
                    please return to the payment page to initiate a new transaction.
                </p>
                
                <div class="status-section">
                    <div class="status-title">Transaction Status</div>
                    <div id="statusContainer">
                        <div class="loading">
                            <span class="spinner"></span>
                            Retrieving payment status...
                        </div>
                    </div>
                </div>
                
                <div class="action-buttons">
                    <a href="/Payment?paymentMethod=jmf" class="btn btn-primary">Try Again</a>
                    <a href="/" class="btn btn-secondary">Return Home</a>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Configuration
        const merchantKey = '4b2a0fbc-87a1-11ee-b9a3-76a2abd30e3c';
        const merchantPass = '03e40b1eacb293b83b3b89f0c413cd46';
        const apiEndpoint = 'https://checkout.jmfinancialkw.com/api/v1/payment/status';

        // Get order ID from query parameters
        function getOrderIdFromUrl() {
            const params = new URLSearchParams(window.location.search);
            return params.get('order_id') || params.get('orderId') || params.get('order');
        }

        // Generate hash for status request
        function generateHash(orderId, merchantPass) {
            const toHash = orderId + merchantPass;
            const md5Hash = CryptoJS.MD5(toHash.toUpperCase()).toString();
            const sha1Hash = CryptoJS.SHA1(md5Hash).toString();
            return sha1Hash;
        }

        // Format date/time
        function formatDateTime(dateString) {
            try {
                const date = new Date(dateString);
                return date.toLocaleString();
            } catch {
                return dateString;
            }
        }

        // Check payment status
        async function checkPaymentStatus() {
            const statusContainer = document.getElementById('statusContainer');
            const orderId = getOrderIdFromUrl();

            if (!orderId) {
                statusContainer.innerHTML = '<div class="error-box">Order ID not found in URL parameters</div>';
                return;
            }

            try {
                // Generate hash
                const hash = generateHash(orderId, merchantPass);

                // Make status request to proxy endpoint
                const response = await fetch('/JMF/Status', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Accept': 'application/json'
                    },
                    body: JSON.stringify({
                        merchant_key: merchantKey,
                        order_id: orderId,
                        hash: hash
                    })
                });

                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }

                const data = await response.json();
                console.log('Status response:', data);

                if (data.error) {
                    statusContainer.innerHTML = `<div class="error-box">Error: ${data.error}</div>`;
                    return;
                }

                // Display status information
                let statusHtml = '<div class="status-box">';
                statusHtml += `<div class="status-item"><div class="status-label">Status:</div><div class="status-value">${data.status || 'Unknown'}</div></div>`;
                statusHtml += `<div class="status-item"><div class="status-label">Date:</div><div class="status-value">${formatDateTime(data.date)}</div></div>`;
                statusHtml += `<div class="status-item"><div class="status-label">Payment ID:</div><div class="status-value">${data.payment_id || 'N/A'}</div></div>`;
                
                if (data.order) {
                    statusHtml += `<div class="status-item"><div class="status-label">Order Number:</div><div class="status-value">${data.order.number || 'N/A'}</div></div>`;
                    statusHtml += `<div class="status-item"><div class="status-label">Amount:</div><div class="status-value">${data.order.amount} ${data.order.currency}</div></div>`;
                    statusHtml += `<div class="status-item"><div class="status-label">Description:</div><div class="status-value">${data.order.description || 'N/A'}</div></div>`;
                }
                
                if (data.customer) {
                    statusHtml += `<div class="status-item"><div class="status-label">Customer Name:</div><div class="status-value">${data.customer.name || 'N/A'}</div></div>`;
                    statusHtml += `<div class="status-item"><div class="status-label">Customer Email:</div><div class="status-value">${data.customer.email || 'N/A'}</div></div>`;
                }
                
                if (data.reason) {
                    statusHtml += `<div class="status-item"><div class="status-label">Reason:</div><div class="status-value">${data.reason}</div></div>`;
                }
                
                statusHtml += '</div>';
                statusContainer.innerHTML = statusHtml;
            } catch (error) {
                console.error('Error checking status:', error);
                statusContainer.innerHTML = `<div class="error-box">Failed to check payment status: ${error.message}</div>`;
            }
        }

        // Check status when page loads
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', checkPaymentStatus);
        } else {
            checkPaymentStatus();
        }
    </script>
</body>
</html>
