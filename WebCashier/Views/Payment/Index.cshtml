@model WebCashier.Models.PaymentModel

@{
    ViewData["Title"] = "Top Up Your Account";
    Layout = "~/Views/Shared/_Layout.cshtml";
}

<div class="payment-container">
    <div class="payment-header">
        <div class="logo-container">
            <img class="logo" src="https://xcite.platform.thexcite.com/resources/svg/trading_logo.svg" alt="zenstox logo" />
            <a href="/" class="back-link">Back to platform</a>
        </div>
    </div>

    <div class="payment-content">
        <h1 class="payment-title">TOP UP YOUR ACCOUNT</h1>
        <p class="security-text">All payments are 100% secure</p>

        <div class="payment-layout">
            <form asp-action="ProcessPayment" method="post" class="payment-form">
                @Html.AntiForgeryToken()
                
                <div class="payment-methods">
                    <p class="method-label">Choose a payment method:</p>
                    <div class="carousel-container">
                        <button type="button" class="carousel-arrow carousel-prev" onclick="movePaymentCarousel(-1)">
                            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                                <path d="M15 18L9 12L15 6" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                            </svg>
                        </button>
                        
                        <div class="method-carousel">
                            <div class="carousel-track">
                                <div class="carousel-item">
                                    <input type="radio" id="card" name="PaymentMethod" value="card" checked />
                                    <label for="card" class="method-option active">
                                        <div class="card-icon" style="margin-top: 5px;">
                                            <svg width="47" height="30" viewBox="0 0 47 30" fill="none" xmlns="http://www.w3.org/2000/svg">
                                                <rect width="47" height="30" rx="4" fill="#4F46E5"/>
                                                <rect x="4" y="7" width="44" height="4" fill="#E5E7EB"/>
                                                <rect x="4" y="16" width="14" height="2" fill="#D1D5DB"/>
                                                <rect x="4" y="20" width="10" height="2" fill="#D1D5DB"/>
                                                <circle cx="42" cy="25" r="4" fill="#10B981"/>
                                                <circle cx="38" cy="25" r="4" fill="#F59E0B"/>
                                            </svg>
                                        </div>
                                        <span class="payment-brand">Praxis CC 1.3</span>
                                    </label>
                                </div>

                                <div class="carousel-item">
                                    <input type="radio" id="paypal" name="PaymentMethod" value="paypal" />
                                    <label for="paypal" class="method-option">
                                        <div class="paypal-icon">
                                            <img src="https://www.paypalobjects.com/marketing/web/logos/paypal-mark-color.svg" alt="PayPal" width="52" height="35" />
                                        </div>
                                        <span class="payment-brand">PayPal v2</span>
                                    </label>
                                </div>

                                <div class="carousel-item" tabindex="0">
                                    <input type="radio" id="jmf" name="PaymentMethod" value="jmf">
                                    <label for="jmf" class="method-option">
                                        <div class="jmf-icon">
                                            <img src="https://jmfinancialkw.com/wp-content/uploads/2023/04/JMF-Logo.png" alt="JMF" width="52" height="35">
                                        </div>
                                        <span class="payment-brand">JM Ak HPP </span>
                                    </label>
                                </div>

                                <div class="carousel-item">
                                    <input type="radio" id="swiftgoldpay" name="PaymentMethod" value="swiftgoldpay" />
                                    <label for="swiftgoldpay" class="method-option">
                                        <div class="swiftgoldpay-icon">
                                            <img src="https://swiftgoldpay.com/static/media/logo.1e15471715130144e5d8.png" alt="SwiftGoldPay" width="60" height="30" style="margin-bottom: 3px; margin-top: 8px; object-fit: contain;" />
                                        </div>
                                        <span class="payment-brand">SwiftGoldPay</span>
                                    </label>
                                </div>

                                <div class="carousel-item">
                                    <input type="radio" id="luxtak" name="PaymentMethod" value="luxtak" />
                                    <label for="luxtak" class="method-option">
                                        <div class="luxtak-icon">
                                            <img src="~/images/luxtak-logo.svg" alt="Luxtak" width="60" height="30" style="margin-bottom: 3px; margin-top: 8px; object-fit: contain;" />
                                        </div>
                                        <span class="payment-brand">Luxtak</span>
                                    </label>
                                </div>

                                <div class="carousel-item">
                                    <input type="radio" id="smilepayz-th" name="PaymentMethod" value="smilepayz-th" />
                                    <label for="smilepayz-th" class="method-option">
                                        <div class="smilepayz-icon">
                                            <img src="https://smilepayz.com/images/logos/logo.png" alt="Smilepayz" width="60" height="30" style="margin-bottom: 3px; margin-top: 8px; object-fit: contain; background-color: #000; padding: 3px;" />
                                        </div>
                                        <span class="payment-brand">Smilepayz TH</span>
                                    </label>
                                </div>

                                <div class="carousel-item">
                                    <input type="radio" id="paysolutions-th" name="PaymentMethod" value="paysolutions-th" />
                                    <label for="paysolutions-th" class="method-option">
                                        <div class="paysolutions-icon">
                                            <img src="https://paysolutions.asia/assets/images-webp/logo-paysolutions@2x.webp" alt="Paysolutions" width="60" height="30" style="margin-bottom: 3px; margin-top: 8px; object-fit: contain;" />
                                        </div>
                                        <span class="payment-brand">Paysolutions TH</span>
                                    </label>
                                </div>

                                <div class="carousel-item">
                                    <input type="radio" id="skrill" name="PaymentMethod" value="skrill" />
                                    <label for="skrill" class="method-option">
                                        <div class="skrill-icon">
                                            <img src="https://www.skrill.com/typo3conf/ext/sitepackage/Resources/Public/images/Skrill-Logo.svg" alt="Skrill" width="60" height="15" style="margin-bottom: 5px; margin-top: 10px;" />
                                        </div>
                                        <span class="payment-brand">Skrill</span>
                                    </label>
                                </div>

                                <div class="carousel-item" id="zmg-item" tabindex="0">
                                    <input type="radio" id="zmg" name="PaymentMethod" value="zmg" />
                                    <label for="zmg" class="method-option" id="zota-label" style="background-color: #0C0B42; border-radius: 8px;">
                                        <div class="zmg-icon">
                                            <img src="https://zota.com/wp-content/uploads/2023/01/zota-logo.svg" alt="Zota" width="60" height="20" />
                                        </div>
                                        <span class="payment-brand" style="color: white;">Zota MG APMs</span>
                                    </label>
                                </div>

                                <div class="carousel-item" id="apple-pay-nuvei-hpp" tabindex="0">
                                    <input type="radio" id="apple-pay-nuvei" name="PaymentMethod" value="apple-pay-nuvei" />
                                    <label for="apple-pay-nuvei" class="method-option">
                                        <div class="apple-pay-nuvei-icon">
                                            <img src="https://upload.wikimedia.org/wikipedia/commons/thumb/b/b0/Apple_Pay_logo.svg/2560px-Apple_Pay_logo.svg.png" alt="Apple Pay Nuvei HPP" width="52" height="35" />
                                        </div>
                                        <span class="payment-brand">Apple Pay HPP</span>
                                    </label>
                                </div>

                                <div class="carousel-item" id="apple-pay-nuvei-iframe" tabindex="0">
                                    <input type="radio" id="apple-pay-nuvei-iframe-radio" name="PaymentMethod" value="apple-pay-nuvei-iframe" />
                                    <label for="apple-pay-nuvei-iframe-radio" class="method-option">
                                        <div class="apple-pay-nuvei-iframe-icon">
                                            <img src="https://upload.wikimedia.org/wikipedia/commons/thumb/b/b0/Apple_Pay_logo.svg/2560px-Apple_Pay_logo.svg.png" alt="Apple Pay Nuvei IF" width="52" height="35" />
                                        </div>
                                        <span class="payment-brand">Apple Pay IFrame</span>
                                    </label>
                                </div>

                                <div class="carousel-item" id="nuvei-simply-connect" tabindex="0">
                                    <input type="radio" id="nuvei-simply-connect-radio" name="PaymentMethod" value="nuvei-simply-connect" />
                                    <label for="nuvei-simply-connect-radio" class="method-option">
                                        <div class="nuvei-simply-connect-icon">
                                            <img src="https://upload.wikimedia.org/wikipedia/commons/e/ee/Nuvei_Organization_logo.png" alt="Nuvei Simply Connect" width="52" height="35" />
                                        </div>
                                        <span class="payment-brand">Nuvei Simply Connect</span>
                                    </label>
                                </div>
                            </div> <!-- /carousel-track -->
                        </div> <!-- /method-carousel -->
                        <button type="button" class="carousel-arrow carousel-next" onclick="movePaymentCarousel(1)">
                            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                                <path d="M9 18L15 12L9 6" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                            </svg>
                        </button>
                    </div> <!-- /carousel-container -->

                <div class="payment-forms">
                    <!-- Praxis Credit Card Form (Default) -->
                    <div id="card-details" class="payment-form-container active">
                        <div class="card-form-layout">
                            <div class="form-left">
                                <!-- Amount suggestion buttons -->
                                <div class="amount-suggestions">
                                    <button type="button" class="amount-btn" data-amount="50">€50</button>
                                    <button type="button" class="amount-btn" data-amount="100">€100</button>
                                    <button type="button" class="amount-btn" data-amount="200">€200</button>
                                </div>

                                <div class="form-row">
                                    <div class="form-group amount-group">
                                        <input name="Amount" type="number" step="0.01" class="form-control" placeholder="Amount" />
                                        <span asp-validation-for="Amount" class="text-danger"></span>
                                    </div>
                                    <div class="form-group currency-group">
                                        <select asp-for="Currency" class="form-control">
                                            <option value="">Currency</option>
                                            <option value="USD">USD</option>
                                            <option value="EUR">EUR</option>
                                            <option value="GBP">GBP</option>
                                            <option value="BRL">BRL</option>
                                        </select>
                                    </div>
                                </div>

                                <div class="form-group">
                                    <input asp-for="CardNumber" class="form-control" placeholder="Card number" maxlength="19" />
                                    <span asp-validation-for="CardNumber" class="text-danger"></span>
                                </div>

                                <div class="form-group">
                                    <input asp-for="NameOnCard" class="form-control" placeholder="Cardholder name" />
                                    <span asp-validation-for="NameOnCard" class="text-danger"></span>
                                </div>

                                <div class="form-row">
                                    <div class="form-group">
                                        <input asp-for="ExpirationDate" class="form-control" placeholder="Exp.date (MM/YY)" maxlength="5" />
                                        <span asp-validation-for="ExpirationDate" class="text-danger"></span>
                                    </div>
                                    <div class="form-group">
                                        <input asp-for="CVV" class="form-control" placeholder="CVV" maxlength="4" />
                                        <span asp-validation-for="CVV" class="text-danger"></span>
                                    </div>
                                </div>

                                <div class="form-group">
                                    <input asp-for="PromotionCode" class="form-control" placeholder="Promotion code (optional)" />
                                </div>
                            </div>

                            <div class="form-right">
                                <div class="interactive-credit-card">
                                    <div class="card-container">
                                        <div class="card-background">
                                            <!-- Front content -->
                                            <div class="card-content card-front-content">
                                                <div class="card-chip"></div>
                                                <div class="card-number" id="card-display">•••• •••• •••• ••••</div>
                                                <div class="card-details">
                                                    <div class="card-holder">
                                                        <div class="card-label">CARDHOLDER NAME</div>
                                                        <div class="card-name" id="name-display">YOUR NAME HERE</div>
                                                    </div>
                                                    <div class="card-expiry-section">
                                                        <div class="card-label">EXPIRES</div>
                                                        <div class="card-expiry" id="expiry-display">MM/YY</div>
                                                    </div>
                                                </div>
                                                <div class="card-brand" id="card-brand"></div>
                                            </div>
                                            
                                            <!-- Back content -->
                                            <div class="card-content card-back-content">
                                                <div class="magnetic-stripe"></div>
                                                <div class="signature-panel">
                                                    <div class="cvv-section">
                                                        <div class="card-label">CVV</div>
                                                        <div class="card-cvv" id="cvv-display-back">•••</div>
                                                    </div>
                                                </div>
                                                <div class="card-brand-back" id="card-brand-back"></div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- PayPal Form -->
                    <div id="paypal-details" class="payment-form-container" style="display: none;">
                        <div class="form-layout">
                            <div class="form-left">
                                <!-- Amount suggestion buttons -->
                                <div class="amount-suggestions">
                                    <button type="button" class="amount-btn" data-amount="50">€50</button>
                                    <button type="button" class="amount-btn" data-amount="100">€100</button>
                                    <button type="button" class="amount-btn" data-amount="200">€200</button>
                                </div>

                                <div class="form-row">
                                    <div class="form-group amount-group">
                                        <input name="PayPalAmount" type="number" step="0.01" class="form-control" placeholder="Amount" />
                                    </div>
                                    <div class="form-group currency-group">
                                        <select name="PayPalCurrency" class="form-control">
                                            <option value="">Currency</option>
                                            <option value="USD">USD</option>
                                            <option value="EUR">EUR</option>
                                            <option value="GBP">GBP</option>
                                            <option value="BRL">BRL</option>
                                        </select>
                                    </div>
                                </div>

                                <div class="form-group">
                                    <input name="PayPalPromotionCode" class="form-control" placeholder="Promotion code (optional)" />
                                </div>
                            </div>

                            <div class="form-right">
                                <div class="payment-info-card">
                                    <h3>PayPal Payment</h3>
                                    <p>You will be redirected to PayPal to complete your payment securely.</p>
                                    <div class="paypal-logo-large">
                                        <img src="https://upload.wikimedia.org/wikipedia/commons/b/b5/PayPal.svg" alt="PayPal" width="150">
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- JM Financial Form -->
                    <div id="jmf-details" class="payment-form-container" style="display: none;">
                        <div class="form-layout">
                            <div class="form-left">
                                <!-- Amount suggestion buttons -->
                                <div class="amount-suggestions">
                                    <button type="button" class="amount-btn" data-amount="100">$100</button>
                                    <button type="button" class="amount-btn" data-amount="150">$150</button>
                                    <button type="button" class="amount-btn" data-amount="199.99">$199.99</button>
                                </div>

                                <div class="form-row">
                                    <div class="form-group amount-group">
                                        <input name="JMFAmount" type="number" step="0.01" min="100.00" max="199.99" class="form-control" placeholder="Amount" />
                                    </div>
                                    <div class="form-group currency-group">
                                        <select name="JMFCurrency" class="form-control">
                                            <option value="">Currency</option>
                                            <option value="USD" selected>USD</option>
                                        </select>
                                    </div>
                                </div>

                                <div class="form-group">
                                    <input name="JMFCustomerName" class="form-control" placeholder="Full Name" value="Tony Stoyanov" />
                                </div>

                                <div class="form-group">
                                    <input name="JMFCustomerEmail" type="email" class="form-control" placeholder="Email Address" value="tony.stoyanov@tiebreak.dev" />
                                </div>
                            </div>

                            <div class="form-right">
                                <div class="payment-info-card">
                                    <h3>JM Financial Hosted Page</h3>
                                    <p>Secure payment processing through JM Financial's hosted payment page.</p>
                                    <div class="jmf-logo-large">
                                        <img src="https://jmfinancialkw.com/wp-content/uploads/2023/04/JMF-Logo.png" alt="JMF" width="120">
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Finshark Form -->
                    <div id="safetypay-details" class="payment-form-container" style="display: none;">
                        <div class="form-layout">
                            <div class="form-left">
                                <!-- Amount suggestion buttons -->
                                <div class="amount-suggestions">
                                    <button type="button" class="amount-btn" data-amount="50">€50</button>
                                    <button type="button" class="amount-btn" data-amount="100">€100</button>
                                    <button type="button" class="amount-btn" data-amount="200">€200</button>
                                </div>

                                <div class="form-row">
                                    <div class="form-group amount-group">
                                        <input name="FinsharkAmount" type="number" step="0.01" class="form-control" placeholder="Amount" />
                                    </div>
                                    <div class="form-group currency-group">
                                        <select name="FinsharkCurrency" class="form-control">
                                            <option value="">Currency</option>
                                            <option value="USD">USD</option>
                                            <option value="EUR">EUR</option>
                                            <option value="GBP">GBP</option>
                                            <option value="BRL">BRL</option>
                                        </select>
                                    </div>
                                </div>

                                <div class="form-group">
                                    <input name="FinsharkPromotionCode" class="form-control" placeholder="Promotion code (optional)" />
                                </div>
                            </div>

                            <div class="form-right">
                                <div class="payment-info-card">
                                    <h3>Finshark Payment</h3>
                                    <p>Secure payment processing via Finshark platform.</p>
                                    <div class="finshark-logo-large">
                                        <svg xmlns="http://www.w3.org/2000/svg" width="150" height="65" viewBox="0 0 300 65.156">
                                          <g id="Logo" transform="translate(-161.42 106.5)">
                                            <path id="Tracciato_19910" data-name="Tracciato 19910" d="M424.871-70.183,435.64-55.45H425.323L416.26-68.884v-1.971l9-12.465h9.811Z" transform="translate(25.779 2.345)" fill="#011025"></path>
                                            <path id="Tracciato_19911" data-name="Tracciato 19911" d="M417.066-67.619v13.434H408.29V-95.82h8.776v28.2Z" transform="translate(24.973 1.08)" fill="#011025"></path>
                                            <path id="Tracciato_19912" data-name="Tracciato 19912" d="M408.233-81.373q-2.61,3.287-5.219,6.6a3.692,3.692,0,0,0-1.432-.98,5.169,5.169,0,0,0-1.949-.341,4.6,4.6,0,0,0-3.469,1.343,5.655,5.655,0,0,0-1.288,4.041V-55.4H386.1v-27.87h8.776v2.114a9.449,9.449,0,0,1,7.169-2.687,9.644,9.644,0,0,1,3.524.595A7.08,7.08,0,0,1,408.233-81.373Z" transform="translate(22.729 2.292)" fill="#011025"></path>
                                            <path id="Tracciato_19913" data-name="Tracciato 19913" d="M384.214-83.267V-55.4h-8.6v-2.257a9.786,9.786,0,0,1-2.588,1.74,11.69,11.69,0,0,1-5.1,1.09,12.6,12.6,0,0,1-6.86-1.894,13.507,13.507,0,0,1-4.757-5.153,15.571,15.571,0,0,1-1.751-7.466,15.558,15.558,0,0,1,1.751-7.455,13.428,13.428,0,0,1,4.757-5.153,12.6,12.6,0,0,1,6.86-1.894A11.558,11.558,0,0,1,373-82.75a9.955,9.955,0,0,1,2.61,1.784v-2.3Zm-8.259,13.93a7.315,7.315,0,0,0-.771-3.436A5.693,5.693,0,0,0,373-75.1a6.271,6.271,0,0,0-3.237-.837,6.283,6.283,0,0,0-3.248.837,6.051,6.051,0,0,0-2.235,2.323,6.957,6.957,0,0,0-.826,3.436,7.016,7.016,0,0,0,.8,3.392A5.949,5.949,0,0,0,366.5-63.6a6.1,6.1,0,0,0,3.2.859,5.879,5.879,0,0,0,4.537-1.861A6.714,6.714,0,0,0,375.956-69.338Z" transform="translate(19.537 2.292)" fill="#011025"></path>
                                            <path id="Tracciato_19914" data-name="Tracciato 19914" d="M353.518-72.024v17.839h-8.776v-15.89A4.791,4.791,0,0,0,343.4-73.6a4.613,4.613,0,0,0-3.414-1.343,5.173,5.173,0,0,0-2.522.595,4.4,4.4,0,0,0-1.718,1.729,4.988,4.988,0,0,0-.639,2.544v15.89H326.33V-95.82h8.776V-80a9.992,9.992,0,0,1,1.839-1.288,11.711,11.711,0,0,1,5.682-1.343,11.826,11.826,0,0,1,5.726,1.343,9.591,9.591,0,0,1,3.821,3.733A11.078,11.078,0,0,1,353.518-72.024Z" transform="translate(16.682 1.08)" fill="#011025"></path>
                                            <path id="Tracciato_19915" data-name="Tracciato 19915" d="M324.8-79.172q-2.494,2.511-4.988,5.043a7.339,7.339,0,0,0-2.951-2.18,8.882,8.882,0,0,0-3.182-.628,4.56,4.56,0,0,0-2.235.429,1.335,1.335,0,0,0-.749,1.233,1.538,1.538,0,0,0,.969,1.376,11.819,11.819,0,0,0,2.533.914c1.024.264,2.114.595,3.259.98a14.327,14.327,0,0,1,3.27,1.542,7.768,7.768,0,0,1,2.533,2.61,8.293,8.293,0,0,1,.969,4.272,7.813,7.813,0,0,1-3.072,6.486q-3.056,2.412-8.281,2.412a18.942,18.942,0,0,1-4.845-.639,17.974,17.974,0,0,1-4.416-1.806a14.229,14.229,0,0,1-3.469-2.72l4.988-5.054a9.483,9.483,0,0,0,3.27,2.323,9.994,9.994,0,0,0,4.129.837,5.007,5.007,0,0,0,2.378-.462,1.4,1.4,0,0,0,.826-1.255,1.714,1.714,0,0,0-1-1.586,12.33,12.33,0,0,0-2.555-.969c-1.024-.286-2.114-.606-3.27-.947a14.587,14.587,0,0,1-3.259-1.432,7.218,7.218,0,0,1-2.533-2.555,8.032,8.032,0,0,1-.969-4.162,8,8,0,0,1,1.376-4.669,9.205,9.205,0,0,1,3.9-3.127,14.252,14.252,0,0,1,5.9-1.145,17.087,17.087,0,0,1,6.574,1.233A11.772,11.772,0,0,1,324.8-79.172Z" transform="translate(14.033 2.271)" fill="#011025"></path>
                                            <path id="Tracciato_19916" data-name="Tracciato 19916" d="M299.878-73.236V-55.4H291.1v-15.89a4.755,4.755,0,0,0-1.354-3.524,4.6,4.6,0,0,0-3.414-1.343,5.2,5.2,0,0,0-2.522.595,4.4,4.4,0,0,0-1.718,1.729,5.1,5.1,0,0,0-.628,2.544V-55.4H272.69v-27.87h8.776v2.18A9.993,9.993,0,0,1,283.5-82.5a12.206,12.206,0,0,1,5.759-1.343,10.2,10.2,0,0,1,5.473,1.465A10.736,10.736,0,0,1,298.5-78.51,10.5,10.5,0,0,1,299.878-73.236Z" transform="translate(11.256 2.292)" fill="#011025"></path>
                                            <path id="Tracciato_19917" data-name="Tracciato 19917" d="M268.886-83.32v27.87H260.11V-83.32h8.776Z" transform="translate(9.982 2.345)" fill="#011025"></path>
                                                <path id="Tracciato_19918" data-name="Tracciato 19918" d="M267.806-92.209a4.565,4.565,0,0,1,1.255,3.27,4.655,4.655,0,0,1-1.255,3.292,4.261,4.261,0,0,1-3.27,1.343,4.271,4.271,0,0,1-3.237-1.343,4.589,4.589,0,0,1-1.288-3.292,4.5,4.5,0,0,1,1.288-3.27,4.333,4.333,0,0,1,3.237-1.321A4.322,4.322,0,0,1,267.806-92.209Z" transform="translate(9.973 1.313)" fill="#011025"></path>
                                                <path id="Tracciato_19919" data-name="Tracciato 19919" d="M262.375-94.22c-1.453,2.147-2.907,4.284-4.35,6.431a3.877,3.877,0,0,0-1.123-.573,3.72,3.72,0,0,0-1.178-.176,2.751,2.751,0,0,0-2.18.837,3.242,3.242,0,0,0-.738,2.257V-82h5.219v7.455h-5.219v20.416H244.03V-74.542H238.81V-82h5.219v-2.984a11.7,11.7,0,0,1,1.432-5.792,10.693,10.693,0,0,1,4.041-4.1,12.039,12.039,0,0,1,6.222-1.531,11.657,11.657,0,0,1,3.557.518A10.47,10.47,0,0,1,262.375-94.22Z" transform="translate(7.828 1.021)" fill="#011025"></path>
                                                <path id="Tracciato_19920" data-name="Tracciato 19920" d="M225.827-55.237a64.532,64.532,0,0,1,.738,9.778,62.178,62.178,0,0,1-32.572-8.732,62.205,62.205,0,0,1-32.572,8.732,64.532,64.532,0,0,1,.738-9.778A55.394,55.394,0,0,0,193.992-65.83,55.367,55.367,0,0,0,225.827-55.237Z" transform="translate(0 4.114)" fill="#011025"></path>
                                                <path id="Tracciato_19921" data-name="Tracciato 19921" d="M226.374-106.5a62.15,62.15,0,0,1-8.732,32.572,64.433,64.433,0,0,1,6.651,16.242A48.15,48.15,0,0,1,213.6-59.337a54.66,54.66,0,0,0-7.6-14.59,53.508,53.508,0,0,0,9.525-21.726A55.364,55.364,0,0,0,174-59.337a48.148,48.148,0,0,1-10.7,1.652A65.16,65.16,0,0,1,226.374-106.5Z" transform="translate(0.189)" fill="#011025"></path>
                                          </g>
                                        </svg>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Skrill Form -->
                    <div id="skrill-details" class="payment-form-container" style="display: none;">
                        <div class="form-layout">
                            <div class="form-left">
                                <!-- Amount suggestion buttons -->
                                <div class="amount-suggestions">
                                    <button type="button" class="amount-btn" data-amount="50">€50</button>
                                    <button type="button" class="amount-btn" data-amount="100">€100</button>
                                    <button type="button" class="amount-btn" data-amount="200">€200</button>
                                </div>

                                <div class="form-row">
                                    <div class="form-group amount-group">
                                        <input name="SkrillAmount" type="number" step="0.01" class="form-control" placeholder="Amount" />
                                    </div>
                                    <div class="form-group currency-group">
                                        <select name="SkrillCurrency" class="form-control">
                                            <option value="">Currency</option>
                                            <option value="USD">USD</option>
                                            <option value="EUR">EUR</option>
                                            <option value="GBP">GBP</option>
                                        </select>
                                    </div>
                                </div>

                                <div class="form-group">
                                    <input name="SkrillPromotionCode" class="form-control" placeholder="Promotion code (optional)" />
                                </div>
                            </div>

                            <div class="form-right">
                                <div class="payment-info-card">
                                    <h3>Skrill Payment</h3>
                                    <p>You will be redirected to Skrill to complete your payment securely.</p>
                                    <div class="skrill-logo-large">
                                        <img src="https://www.skrill.com/typo3conf/ext/sitepackage/Resources/Public/images/Skrill-Logo.svg" alt="Skrill" width="150" />
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Zota Form -->
                    <div id="zmg-details" class="payment-form-container" style="display: none;">
                        <div class="form-layout">
                            <div class="form-left">
                                <!-- Amount suggestion buttons -->
                                <div class="amount-suggestions">
                                    <button type="button" class="amount-btn" data-amount="50">€50</button>
                                    <button type="button" class="amount-btn" data-amount="100">€100</button>
                                    <button type="button" class="amount-btn" data-amount="200">€200</button>
                                </div>

                                <div class="form-row">
                                    <div class="form-group amount-group">
                                        <input name="ZotaAmount" type="number" step="0.01" class="form-control" placeholder="Amount" />
                                    </div>
                                    <div class="form-group currency-group">
                                        <select name="ZotaCurrency" class="form-control">
                                            <option value="">Currency</option>
                                            <option value="USD">USD</option>
                                            <option value="EUR">EUR</option>
                                            <option value="GBP">GBP</option>
                                        </select>
                                    </div>
                                </div>

                                <div class="form-group">
                                    <input name="ZotaPromotionCode" class="form-control" placeholder="Promotion code (optional)" />
                                </div>
                            </div>

                            <div class="form-right">
                                <div class="payment-info-card" style="background-color: #0C0B42; color: white;">
                                    <h3 style="color: white;">Zota Payment</h3>
                                    <p style="color: white;">Secure payment processing via Zota platform.</p>
                                    <div class="zota-logo-large">
                                        <img src="https://zota.com/wp-content/uploads/2023/01/zota-logo.svg" alt="Zota" width="150" />
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Apple Pay Nuvei HPP Form -->
                    <div id="apple-pay-nuvei-details" class="payment-form-container" style="display: none;">
                        <div class="form-layout">
                            <div class="form-left">
                                <!-- Amount suggestion buttons -->
                                <div class="amount-suggestions">
                                    <button type="button" class="amount-btn" data-amount="50">€50</button>
                                    <button type="button" class="amount-btn" data-amount="100">€100</button>
                                    <button type="button" class="amount-btn" data-amount="200">€200</button>
                                </div>

                                <div class="form-row">
                                    <div class="form-group amount-group">
                                        <input name="ApplePayAmount" type="number" step="0.01" class="form-control" placeholder="Amount" />
                                    </div>
                                    <div class="form-group currency-group">
                                        <select name="ApplePayCurrency" class="form-control">
                                            <option value="">Currency</option>
                                            <option value="USD">USD</option>
                                            <option value="EUR">EUR</option>
                                            <option value="GBP">GBP</option>
                                            <option value="BRL">BRL</option>
                                        </select>
                                    </div>
                                </div>

                                <div class="form-group">
                                    <input name="ApplePayPromotionCode" class="form-control" placeholder="Promotion code (optional)" />
                                </div>
                            </div>

                            <div class="form-right">
                                <div class="payment-info-card">
                                    <h3>Apple Pay via Nuvei HPP</h3>
                                    <p>Quick and secure payments with Apple Pay through Nuvei's Hosted Payment Page.</p>
                                    <div class="apple-pay-logo-large">
                                        <img src="https://upload.wikimedia.org/wikipedia/commons/thumb/b/b0/Apple_Pay_logo.svg/2560px-Apple_Pay_logo.svg.png" alt="Apple Pay" width="120" />
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Apple Pay Nuvei IFrame Form -->
                    <div id="apple-pay-nuvei-iframe-details" class="payment-form-container" style="display: none;">
                        <div class="form-layout">
                            <div class="form-left">
                                <!-- Amount suggestion buttons -->
                                <div class="amount-suggestions">
                                    <button type="button" class="amount-btn" data-amount="50">€50</button>
                                    <button type="button" class="amount-btn" data-amount="100">€100</button>
                                    <button type="button" class="amount-btn" data-amount="200">€200</button>
                                </div>

                                <div class="form-row">
                                    <div class="form-group amount-group">
                                        <input name="ApplePayIFrameAmount" type="number" step="0.01" class="form-control" placeholder="Amount" />
                                    </div>
                                    <div class="form-group currency-group">
                                        <select name="ApplePayIFrameCurrency" class="form-control">
                                            <option value="">Currency</option>
                                            <option value="USD">USD</option>
                                            <option value="EUR">EUR</option>
                                            <option value="GBP">GBP</option>
                                            <option value="BRL">BRL</option>
                                        </select>
                                    </div>
                                </div>

                                <div class="form-group">
                                    <input name="ApplePayIFramePromotionCode" class="form-control" placeholder="Promotion code (optional)" />
                                </div>
                            </div>

                            <div class="form-right">
                                <div class="payment-info-card">
                                    <h3>Apple Pay via Nuvei IFrame</h3>
                                    <p>Quick and secure payments with Apple Pay through Nuvei's embedded payment form.</p>
                                    <div class="apple-pay-logo-large">
                                        <img src="https://upload.wikimedia.org/wikipedia/commons/thumb/b/b0/Apple_Pay_logo.svg/2560px-Apple_Pay_logo.svg.png" alt="Apple Pay" width="120" />
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Nuvei IFrame container -->
                        <div id="apple-pay-nuvei-iframe-container" style="width: 100%; height: 600px; border: 1px solid #d3dce6; background-color: #f5f5f5; display: none; margin-top: 20px;">
                            <iframe id="nuvei-apple-pay-iframe" name="nuvei_apple_pay" style="width: 100%; height: 100%; border: none;"></iframe>
                        </div>
                    </div>

                    <!-- Nuvei Simply Connect Form -->
                    <div id="nuvei-simply-connect-details" class="payment-form-container" style="display: none;">
                        <div class="form-layout">
                            <div class="form-left">
                                <!-- Amount suggestion buttons -->
                                <div class="amount-suggestions">
                                    <button type="button" class="amount-btn active" data-amount="50">€50</button>
                                    <button type="button" class="amount-btn" data-amount="100">€100</button>
                                    <button type="button" class="amount-btn" data-amount="200">€200</button>
                                </div>

                                <div class="form-row">
                                    <div class="form-group amount-group">
                                        <input name="NuveiSimplyConnectAmount" type="number" step="0.01" class="form-control" placeholder="Amount" />
                                    </div>
                                    <div class="form-group currency-group">
                                        <select name="NuveiSimplyConnectCurrency" class="form-control">
                                            <option value="">Currency</option>
                                            <option value="USD">USD</option>
                                            <option value="EUR">EUR</option>
                                            <option value="GBP">GBP</option>
                                            <option value="BRL">BRL</option>
                                        </select>
                                    </div>
                                </div>

                                <div class="form-group">
                                    <input name="NuveiSimplyConnectPromotionCode" class="form-control" placeholder="Promotion code (optional)" />
                                </div>
                            </div>

                            <div class="form-right">
                                <!-- Hidden inputs to store session data -->
                                <input type="hidden" id="nuvei-session-token" />
                                <input type="hidden" id="nuvei-merchant-id" />
                                <input type="hidden" id="nuvei-merchant-site-id" />
                                <input type="hidden" id="nuvei-order-id" />
                            </div>
                        </div>
                        
                        <!-- Nuvei Checkout Container (hidden until Deposit is clicked) -->
                        <div class="checkout" id="nuvei-checkout" style="width: 100%; height: 600px; border: 1px solid #d3dce6; background-color: #f5f5f5; display: none; align-items: center; justify-content: center; margin-top: 20px;"></div>
                    </div>

                    <div id="gpay-details" class="payment-form-container" style="display: none;">
                        <div class="form-layout">
                            <div class="form-left">
                                <!-- Amount suggestion buttons -->
                                <div class="amount-suggestions">
                                    <button type="button" class="amount-btn" data-amount="50">€50</button>
                                    <button type="button" class="amount-btn" data-amount="100">€100</button>
                                    <button type="button" class="amount-btn" data-amount="200">€200</button>
                                </div>

                                <div class="form-row">
                                    <div class="form-group amount-group">
                                        <input name="GPayAmount" type="number" step="0.01" class="form-control" placeholder="Amount" />
                                    </div>
                                    <div class="form-group currency-group">
                                        <select name="GPayCurrency" class="form-control">
                                            <option value="">Currency</option>
                                            <option value="USD">USD</option>
                                            <option value="EUR">EUR</option>
                                            <option value="GBP">GBP</option>
                                        </select>
                                    </div>
                                </div>

                                <div class="form-group">
                                    <input name="GPayPromotionCode" class="form-control" placeholder="Promotion code (optional)" />
                                </div>
                            </div>

                            <div class="form-right">
                                <div class="payment-info-card">
                                    <h3>Google Pay</h3>
                                    <p>Quick and secure payments with Google Pay.</p>
                                    <div class="gpay-logo-large">
                                        <img src="https://developers.google.com/static/pay/api/images/brand-guidelines/google-pay-mark.png" alt="Google Pay" width="120" />
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- SwiftGoldPay Form -->
                    <div id="swiftgoldpay-details" class="payment-form-container" style="display: none;">
                        <div class="form-layout">
                            <div class="form-left">
                                <!-- Amount suggestion buttons -->
                                <div class="amount-suggestions">
                                    <button type="button" class="amount-btn" data-amount="500">฿500</button>
                                    <button type="button" class="amount-btn" data-amount="1000">฿1000</button>
                                    <button type="button" class="amount-btn" data-amount="2000">฿2000</button>
                                </div>

                                <div class="form-row">
                                    <div class="form-group amount-group">
                                        <input name="SwiftGoldPayAmount" type="number" step="0.01" class="form-control" placeholder="Amount" />
                                    </div>
                                    <div class="form-group currency-group">
                                        <select name="SwiftGoldPayCurrency" class="form-control">
                                            <option value="">Currency</option>
                                            <option value="THB" selected>THB</option>
                                        </select>
                                    </div>
                                </div>

                                <div class="form-group">
                                    <label for="SwiftGoldPayBankSelect" class="form-label">Select your bank</label>
                                    <select id="SwiftGoldPayBankSelect" class="form-control">
                                        <option value="">Loading banks...</option>
                                    </select>
                                    <div id="SwiftGoldPayBanksError" class="text-danger" style="display:none; font-weight:700;"></div>
                                </div>
                                <div class="form-group">
                                    <label for="SwiftGoldPayBankAccount" class="form-label">Bank Account Number</label>
                                    <input id="SwiftGoldPayBankAccount" class="form-control" placeholder="Enter your bank account number" />
                                </div>

                                <!-- SwiftGoldPay Result (QR + Status) -->
                                <div id="SwiftGoldPayResult" class="payment-info-card" style="display:none; margin-top: 16px;">
                                    <p class="sgp-instruction" style="margin-bottom:8px; font-weight:600;">Please scan this code to finish your deposit.</p>
                                    <div style="display:flex; align-items:flex-start; gap:16px; flex-wrap:wrap;">
                                        <img id="SwiftGoldPayQr" alt="SwiftGoldPay QR" style="width:220px; height:220px; object-fit:contain; border:1px solid #e5e7eb; border-radius:8px; background:#fff;" />
                                        <div style="flex:1; min-width:260px;">
                                            <div style="display:flex; align-items:center; gap:10px; margin-bottom:10px;">
                                                <button id="SwiftGoldPayCheckStatusBtn" type="button" class="deposit-btn" style="padding:10px 14px; height:auto;">Check Deposit Status</button>
                                                <span id="SwiftGoldPayRef" style="font-size:12px; color:#6b7280;">Ref: <span id="SwiftGoldPayRefValue">-</span></span>
                                            </div>
                                            <div id="SwiftGoldPayStatusError" class="text-danger" style="display:none; font-weight:700;"></div>
                                            <div id="SwiftGoldPayStatusTableWrap" style="display:none; overflow:auto; max-height:260px; border:1px solid #e5e7eb; border-radius:8px;">
                                                <table id="SwiftGoldPayStatusTable" class="table" style="width:100%; margin:0;">
                                                    <thead>
                                                        <tr>
                                                            <th>UID</th>
                                                            <th>Ref No</th>
                                                            <th>Amount</th>
                                                            <th>Currency</th>
                                                            <th>Process</th>
                                                            <th>Status</th>
                                                        </tr>
                                                    </thead>
                                                    <tbody></tbody>
                                                </table>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <div class="form-right">
                                <div class="payment-info-card">
                                    <h3>SwiftGoldPay</h3>
                                    <p>Thai bank payments via SwiftGoldPay.</p>
                                    <div class="swiftgoldpay-logo-large">
                                        <img src="https://swiftgoldpay.com/static/media/logo.1e15471715130144e5d8.png" alt="SwiftGoldPay" width="150" style="object-fit: contain;" />
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Luxtak Form -->
                    <div id="luxtak-details" class="payment-form-container" style="display: none;">
                        <div class="form-layout">
                            <div class="form-left">
                                <!-- Amount suggestion buttons -->
                                <div class="amount-suggestions">
                                    <button type="button" class="amount-btn" data-amount="50">€50</button>
                                    <button type="button" class="amount-btn" data-amount="100">€100</button>
                                    <button type="button" class="amount-btn" data-amount="200">€200</button>
                                </div>

                                <div class="form-row">
                                    <div class="form-group amount-group">
                                        <input name="LuxtakAmount" type="number" step="0.01" class="form-control" placeholder="Amount" />
                                    </div>
                                    <div class="form-group currency-group">
                                        <select name="LuxtakCurrency" class="form-control">
                                            <option value="">Currency</option>
                                            <option value="USD">USD</option>
                                            <option value="EUR">EUR</option>
                                            <option value="GBP">GBP</option>
                                            <option value="BRL">BRL</option>
                                        </select>
                                    </div>
                                </div>
                            </div>

                            <div class="form-right">
                                <div class="payment-info-card">
                                    <h3>Luxtak Payment</h3>
                                    <p>Secure and fast payment processing via Luxtak platform.</p>
                                    <div class="luxtak-logo-large">
                                        <img src="~/images/luxtak-logo.svg" alt="Luxtak" width="150" />
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Smilepayz TH Form (copied from Luxtak) -->
                    <div id="smilepayz-details" class="payment-form-container" style="display: none;">
                        <div class="form-layout">
                            <div class="form-left">
                                <!-- Amount suggestion buttons -->
                                <div class="amount-suggestions">
                                    <button type="button" class="amount-btn" data-amount="500">฿500</button>
                                    <button type="button" class="amount-btn" data-amount="1000">฿1000</button>
                                    <button type="button" class="amount-btn" data-amount="2000">฿2000</button>
                                </div>

                                <div class="form-row">
                                    <div class="form-group amount-group">
                                        <input name="SmilepayzAmount" type="number" step="1" class="form-control" placeholder="Amount (THB)" />
                                    </div>
                                    <div class="form-group currency-group">
                                        <select name="SmilepayzCurrency" class="form-control">
                                            <option value="">Currency</option>
                                            <option value="THB" selected>THB</option>
                                        </select>
                                    </div>
                                </div>
                            </div>

                            <div class="form-right">
                                <div class="payment-info-card">
                                    <h3>Smilepayz TH Payment</h3>
                                    <p>Secure and fast payment processing via Smilepayz Thailand.</p>
                                    <div class="smilepayz-logo-large">
                                        <img src="https://smilepayz.com/images/logos/logo.png" alt="Smilepayz" width="150" style="background-color: #000;\n    padding: 5px;" />
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div id="paysolutions-details" class="payment-form-container" style="display: none;">
                        <div class="form-layout">
                            <div class="form-left">
                                <!-- Amount suggestion buttons -->
                                <div class="amount-suggestions">
                                    <button type="button" class="amount-btn" data-amount="500">฿500</button>
                                    <button type="button" class="amount-btn" data-amount="1000">฿1000</button>
                                    <button type="button" class="amount-btn" data-amount="2000">฿2000</button>
                                </div>

                                <div class="form-row">
                                    <div class="form-group amount-group">
                                        <input name="PaysolutionsAmount" type="number" step="1" class="form-control" placeholder="Amount (THB)" />
                                    </div>
                                    <div class="form-group currency-group">
                                        <select name="PaysolutionsCurrency" class="form-control">
                                            <option value="">Currency</option>
                                            <option value="THB" selected>THB</option>
                                        </select>
                                    </div>
                                </div>
                            </div>

                            <div class="form-right">
                                <div class="payment-info-card">
                                    <h3>Paysolutions TH Payment</h3>
                                    <p>Secure Thailand THB QR e-banking via Paysolutions.</p>
                                    <div class="paysolutions-logo-large">
                                        <img src="https://paysolutions.asia/assets/images-webp/logo-paysolutions@2x.webp" alt="Paysolutions" width="150" />
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <p class="currency-note">Please note that you might be charged in a different currency</p>

                <button type="submit" class="deposit-btn" id="deposit-btn" disabled>DEPOSIT</button>
            </form>
        </div>
    </div>
</div>
<!-- Apple Pay Nuvei Confirmation Modal -->
<div id="applepay-nuvei-modal" class="luxtak-modal" style="display:none;">
    <div class="luxtak-modal-content">
        <div class="luxtak-modal-header">
            <h3 id="applepay-nuvei-modal-title">Apple Pay Nuvei HPP</h3>
        </div>
        <div class="luxtak-modal-body">
            <p id="applepay-nuvei-modal-message">Apple Pay Nuvei HPP will open in a new tab. Continue?</p>
            <div id="applepay-nuvei-error" class="text-danger" style="display:none;"></div>
        </div>
        <div class="luxtak-modal-footer">
            <button id="applepay-nuvei-ok-btn" class="btn-ok">OK</button>
            <button id="applepay-nuvei-cancel-btn" class="btn-cancel">Cancel</button>
        </div>
    </div>
</div>

<!-- Nuvei (GPay) Modal with iframe -->
<div id="nuvei-modal" class="luxtak-modal" style="display:none;">
    <div class="luxtak-modal-content" style="max-width: 900px; height: 80vh; padding: 0; position: relative;">
        <button id="nuvei-close-btn" style="position: absolute; top: 10px; right: 10px; z-index: 1000; background: #fff; border: 1px solid #ccc; border-radius: 50%; width: 32px; height: 32px; cursor: pointer; font-size: 18px; line-height: 1; padding: 0; display: flex; align-items: center; justify-content: center; box-shadow: 0 2px 4px rgba(0,0,0,0.1);">&times;</button>
        <div id="nuvei-iframe-container" style="width: 100%; height: 100%; border-radius: 8px; overflow: hidden;">
            <iframe id="nuvei-iframe" name="nuvei-iframe" style="width: 100%; height: 100%; border: none;" allow="payment; geolocation"></iframe>
        </div>
    </div>
</div>

<!-- Zota MG Modal -->
<div id="zota-modal" class="luxtak-modal" style="display:none;">
    <div class="luxtak-modal-content">
        <div class="luxtak-modal-header">
            <h3 id="zota-modal-title">Open Zota MG</h3>
        </div>
        <div class="luxtak-modal-body">
            <p id="zota-modal-message">Zota MG will open in a new tab. Continue?</p>
            <div id="zota-error" class="text-danger" style="display:none;"></div>
        </div>
        <div class="luxtak-modal-footer">
            <button id="zota-ok-btn" class="btn-ok">OK</button>
            <button id="zota-cancel-btn" class="btn-cancel">Cancel</button>
        </div>
    </div>
    
</div>
<!-- Loading Overlay -->
<div id="loading-overlay" class="loading-overlay" style="display: none;">
    <div class="loading-content">
        <div class="loading-spinner">
            <div class="spinner"></div>
        </div>
        <h3 class="loading-title">Transaction in progress</h3>
        <p class="loading-message">Please wait while we process your payment...</p>
    </div>
</div>

<!-- Luxtak Modal -->
<div id="luxtak-modal" class="luxtak-modal" style="display: none;">
    <div class="luxtak-modal-content">
        <div class="luxtak-modal-header">
            <h3 id="luxtak-modal-title">Luxtak Payment</h3>
        </div>
        <div class="luxtak-modal-body">
            <p id="luxtak-modal-message"></p>
        </div>
        <div class="luxtak-modal-footer">
            <button id="luxtak-ok-btn" class="btn-ok" style="display: none;">OK</button>
            <button id="luxtak-cancel-btn" class="btn-cancel">Cancel</button>
        </div>
    </div>
</div>

<!-- Paysolutions Modal -->
<div id="paysolutions-modal" class="luxtak-modal" style="display: none;">
    <div class="luxtak-modal-content" style="max-width: 600px; max-height: 100vh; overflow-y: auto; padding: 20px 24px;">
        <div class="luxtak-modal-header" style="padding-bottom: 12px; border-bottom: 1px solid #e6e8ec; margin-bottom: 12px;">
            <h3 id="paysolutions-modal-title" style="margin: 0; font-size: 20px; font-weight: 700; color: #0f172a;">Scan QR Code to Deposit</h3>
        </div>
        <div class="luxtak-modal-body" style="padding-bottom: 8px;">
            <div id="paysolutions-data-container" style="display: none;">
                <div id="paysolutions-qr-image" style="text-align: center; margin: 12px 0 16px 0;">
                    <img id="paysolutions-image" src="" alt="QR Code" style="max-width: 320px; width: 100%; height: auto; border-radius: 10px; box-shadow: 0 8px 18px rgba(0,0,0,0.08);" />
                </div>
                <div id="paysolutions-details" style="background: #f8fafc; border: 1px solid #e2e8f0; border-radius: 10px; padding: 14px 16px; margin: 12px 0 4px 0;">
                    <div style="display: flex; justify-content: space-between; padding: 8px 0; border-bottom: 1px solid #e2e8f0; font-size: 14px; line-height: 20px;">
                        <span style="font-weight: 600; color: #475569;">Order Number</span>
                        <span id="paysolutions-orderNo" style="font-weight: 700; color: #0f172a;"></span>
                    </div>
                    <div style="display: flex; justify-content: space-between; padding: 8px 0; border-bottom: 1px solid #e2e8f0; font-size: 14px; line-height: 20px;">
                        <span style="font-weight: 600; color: #475569;">Reference Number</span>
                        <span id="paysolutions-referenceNo" style="font-weight: 700; color: #0f172a;"></span>
                    </div>
                    <div style="display: flex; justify-content: space-between; padding: 8px 0; border-bottom: 1px solid #e2e8f0; font-size: 14px; line-height: 20px;">
                        <span style="font-weight: 600; color: #475569;">Total</span>
                        <span id="paysolutions-total" style="font-weight: 700; color: #0f172a;"></span>
                    </div>
                    <div style="display: flex; justify-content: space-between; padding: 8px 0; border-bottom: 1px solid #e2e8f0; font-size: 14px; line-height: 20px;">
                        <span style="font-weight: 600; color: #475569;">Order Date & Time</span>
                        <span id="paysolutions-orderdatetime" style="font-weight: 700; color: #0f172a;"></span>
                    </div>
                    <div style="display: flex; justify-content: space-between; padding: 8px 0; font-size: 14px; line-height: 20px;">
                        <span style="font-weight: 600; color: #475569;">Expiry Date</span>
                        <span id="paysolutions-expiredate" style="font-weight: 700; color: #b91c1c;"></span>
                    </div>
                </div>
            </div>
            <p id="paysolutions-modal-message" style="display: none; margin: 12px 0 0 0; text-align: center; color: #475569; font-size: 14px;">Generating Paysolutions QR... Please wait.</p>
        </div>
        <div class="luxtak-modal-footer" style="padding-top: 10px; margin-top: 4px; border-top: 1px solid #e6e8ec;">
            <button id="paysolutions-ok-btn" class="btn-ok" style="width: 100%;">Done</button>
        </div>
    </div>
</div>

@section Scripts {
    @{await Html.RenderPartialAsync("_ValidationScriptsPartial");}
    <script>
        // Suppress extension-related console errors
        const originalError = console.error;
        console.error = function(...args) {
            const errorMessage = args.join(' ');
            // Filter out common extension-related errors
            if (errorMessage.includes('runtime.lastError') || 
                errorMessage.includes('duplicate id') ||
                errorMessage.includes('Extension context invalidated')) {
                return; // Don't log these errors
            }
            originalError.apply(console, args);
        };

        // Add missing jQuery Validate creditcard method
        if (typeof $.validator !== 'undefined') {
            $.validator.addMethod("creditcard", function(value, element) {
                // Remove spaces and non-numeric characters
                value = value.replace(/\s/g, '').replace(/[^0-9]/g, '');
                
                // Check if empty
                if (!value) return false;
                
                // Basic length check
                if (value.length < 13 || value.length > 19) return false;
                
                // Luhn algorithm for credit card validation
                var sum = 0;
                var shouldDouble = false;
                
                for (var i = value.length - 1; i >= 0; i--) {
                    var digit = parseInt(value.charAt(i));
                    
                    if (shouldDouble) {
                        digit *= 2;
                        if (digit > 9) digit -= 9;
                    }
                    
                    sum += digit;
                    shouldDouble = !shouldDouble;
                }
                
                return (sum % 10) === 0;
            }, "Please enter a valid credit card number");
        }

        // Card widget elements
        const cardDisplay = document.getElementById('card-display');
        const nameDisplay = document.getElementById('name-display');
        const expiryDisplay = document.getElementById('expiry-display');
        const cvvDisplayBack = document.getElementById('cvv-display-back');
        const cardBrandDisplay = document.getElementById('card-brand');
        const cardBrandBack = document.getElementById('card-brand-back');
        const cardContainer = document.querySelector('.card-container');
        const cardBackground = document.querySelector('.card-background');
        const cardFrontContent = document.querySelector('.card-front-content');
        const cardBackContent = document.querySelector('.card-back-content');

        // Format card number input and update widget
        document.querySelector('[name="CardNumber"]').addEventListener('input', function(e) {
            let value = e.target.value.replace(/\s/g, '').replace(/[^0-9]/gi, '');
            let formattedValue = value.match(/.{1,4}/g)?.join(' ') || value;
            e.target.value = formattedValue;
            
            // Update card display - only show user input
            if (value.length > 0) {
                // Create display value with proper spacing
                let displayValue = '';
                for (let i = 0; i < 16; i++) {
                    if (i < value.length) {
                        displayValue += value[i];
                    } else {
                        displayValue += '•';
                    }
                    // Add space after every 4 digits except the last group
                    if ((i + 1) % 4 === 0 && i < 15) {
                        displayValue += ' ';
                    }
                }
                cardDisplay.textContent = displayValue;
            } else {
                cardDisplay.textContent = '•••• •••• •••• ••••';
            }
            
            // Detect card brand and update styling
            updateCardBrand(value);
        });

        // Flip back to front when focusing on card number
        document.querySelector('[name="CardNumber"]').addEventListener('focus', function(e) {
            console.log('Card number focused - flipping to front');
            if (cardContainer) {
                cardContainer.classList.remove('flipped');
                console.log('Removed flipped class');
            }
        });

        // Format expiration date and update widget
        document.querySelector('[name="ExpirationDate"]').addEventListener('input', function(e) {
            let value = e.target.value.replace(/\D/g, '');
            if (value.length >= 2) {
                value = value.substring(0,2) + '/' + value.substring(2,4);
            }
            e.target.value = value;
            
            // Update expiry display - only show user input
            if (value.length > 0) {
                expiryDisplay.textContent = value;
            } else {
                expiryDisplay.textContent = 'MM/YY';
            }
        });

        // Flip back to front when focusing on expiration date
        document.querySelector('[name="ExpirationDate"]').addEventListener('focus', function(e) {
            if (cardContainer) {
                cardContainer.classList.remove('flipped');
            }
        });

        // Update name on card - only show user input
        document.querySelector('[name="NameOnCard"]').addEventListener('input', function(e) {
            const name = e.target.value.trim().toUpperCase();
            if (name.length > 0) {
                nameDisplay.textContent = name;
            } else {
                nameDisplay.textContent = 'YOUR NAME HERE';
            }
            
            // Validate name on card with delay
            setTimeout(() => validateNameOnCard(true), 150);
        });

        // Flip back to front when focusing on name
        document.querySelector('[name="NameOnCard"]').addEventListener('focus', function(e) {
            if (cardContainer) {
                cardContainer.classList.remove('flipped');
            }
        });

        // Update CVV - only show user input and handle card flipping
        document.querySelector('[name="CVV"]').addEventListener('focus', function(e) {
            // Flip card to back side with 3D animation
            console.log('CVV focused - flipping to back');
            if (cardContainer) {
                cardContainer.classList.add('flipped');
                console.log('Added flipped class');
            } else {
                console.log('cardContainer not found');
            }
        });

        document.querySelector('[name="CVV"]').addEventListener('blur', function(e) {
            // Don't auto-flip back on blur - let user decide by clicking other inputs
            console.log('CVV blurred');
        });

        document.querySelector('[name="CVV"]').addEventListener('input', function(e) {
            const cvv = e.target.value.trim();
            if (cvv.length > 0) {
                cvvDisplayBack.textContent = cvv;
            } else {
                cvvDisplayBack.textContent = '•••';
            }
            
            // Validate CVV with delay
            setTimeout(() => validateCVV(true), 150);
        });

        // Card brand detection and styling
        function updateCardBrand(cardNumber) {
            const firstDigit = cardNumber.charAt(0);
            const firstTwoDigits = cardNumber.substring(0, 2);
            const firstFourDigits = cardNumber.substring(0, 4);

            // Reset classes on card background
            if (cardBackground) {
                cardBackground.className = 'card-background';
            }

            if (cardNumber.length === 0) {
                if (cardBrandDisplay) cardBrandDisplay.textContent = '';
                if (cardBrandBack) cardBrandBack.textContent = '';
                if (cardBackground) cardBackground.classList.add('default-card');
                return;
            }

            let brandName = '';
            if (cardNumber.startsWith('4')) {
                brandName = 'VISA';
                if (cardBackground) cardBackground.classList.add('visa-card');
            } else if (isMastercard(cardNumber)) {
                brandName = 'MASTERCARD';
                if (cardBackground) cardBackground.classList.add('mastercard-card');
            } else if (cardNumber.startsWith('34') || cardNumber.startsWith('37')) {
                brandName = 'AMEX';
                if (cardBackground) cardBackground.classList.add('amex-card');
            } else if (cardNumber.startsWith('6011') || firstTwoDigits === '65') {
                brandName = 'DISCOVER';
                if (cardBackground) cardBackground.classList.add('discover-card');
            } else {
                brandName = '';
                if (cardBackground) cardBackground.classList.add('default-card');
            }
            
            // Update both front and back brand displays
            if (cardBrandDisplay) cardBrandDisplay.textContent = brandName;
            if (cardBrandBack) cardBrandBack.textContent = brandName;
        }

        // Enhanced Mastercard detection function
        function isMastercard(cardNumber) {
            const firstTwoDigits = parseInt(cardNumber.substring(0, 2));
            const firstFourDigits = parseInt(cardNumber.substring(0, 4));
            
            // Original Mastercard range: 51-55
            if (firstTwoDigits >= 51 && firstTwoDigits <= 55) {
                return true;
            }
            
            // New Mastercard 2-series range: 2221-2720
            if (firstFourDigits >= 2221 && firstFourDigits <= 2720) {
                return true;
            }
            
            return false;
        }

        // Toggle payment method details and forms
        document.querySelectorAll('input[name="PaymentMethod"]').forEach(radio => {
            radio.addEventListener('change', function() {
                // Update active state for carousel items
                document.querySelectorAll('.method-option').forEach(opt => opt.classList.remove('active'));
                this.nextElementSibling.classList.add('active');
                
                // Hide all payment forms first
                document.querySelectorAll('.payment-form-container').forEach(form => {
                    form.style.display = 'none';
                    form.classList.remove('active');
                });
                
                // Show the corresponding payment form
                const selectedMethod = this.value;
                let targetFormId = '';
                
                switch(selectedMethod) {
                    case 'card':
                        targetFormId = 'card-details';
                        break;
                    case 'paypal':
                        targetFormId = 'paypal-details';
                        break;
                    case 'jmf':
                        targetFormId = 'jmf-details';
                        break;
                    case 'swiftgoldpay':
                        targetFormId = 'swiftgoldpay-details';
                        break;
                    case 'skrill':
                        targetFormId = 'skrill-details';
                        break;
                    case 'zmg':
                        targetFormId = 'zmg-details';
                        break;
                    case 'gpay':
                        targetFormId = 'gpay-details';
                        break;
                    case 'apple-pay-nuvei':
                        targetFormId = 'apple-pay-nuvei-details';
                        break;
                    case 'apple-pay-nuvei-iframe':
                        targetFormId = 'apple-pay-nuvei-iframe-details';
                        break;
                    case 'luxtak':
                        targetFormId = 'luxtak-details';
                        break;
                    case 'smilepayz-th':
                        targetFormId = 'smilepayz-details';
                        break;
                    case 'paysolutions-th':
                        targetFormId = 'paysolutions-details';
                        break;
                    case 'nuvei-simply-connect':
                        targetFormId = 'nuvei-simply-connect-details';
                        break;
                    default:
                        targetFormId = 'card-details'; // fallback to card
                }
                
                // Show the selected form
                const targetForm = document.getElementById(targetFormId);
                if (targetForm) {
                    targetForm.style.display = 'block';
                    targetForm.classList.add('active');
                }
                
                // Update deposit button state
                updateDepositButtonState();
                
                console.log(`Switched to payment method: ${selectedMethod}, showing form: ${targetFormId}`);
            });
        });

        // Amount suggestion buttons
        document.querySelectorAll('.amount-btn').forEach(button => {
            button.addEventListener('click', function() {
                const amount = this.getAttribute('data-amount');
                
                // Find the active payment form and update its amount input
                const activeForm = document.querySelector('.payment-form-container.active');
                if (activeForm) {
                    const amountInput = activeForm.querySelector('input[type="number"]');
                    if (amountInput) {
                        amountInput.value = amount;
                    }
                }
                
                // Also update the main Amount input for backwards compatibility
                const mainAmountInput = document.querySelector('[name="Amount"]');
                if (mainAmountInput) {
                    mainAmountInput.value = amount;
                }
                
                // Update Luxtak specific fields if Luxtak is active
                const selectedPaymentMethod = document.querySelector('input[name="PaymentMethod"]:checked')?.value;
                if (selectedPaymentMethod === 'luxtak') {
                    const luxtakAmountInput = document.querySelector('[name="LuxtakAmount"]');
                    if (luxtakAmountInput) {
                        luxtakAmountInput.value = amount;
                    }
                } else if (selectedPaymentMethod === 'smilepayz-th') {
                    const spAmountInput = document.querySelector('[name="SmilepayzAmount"]');
                    if (spAmountInput) {
                        spAmountInput.value = amount;
                    }
                } else if (selectedPaymentMethod === 'paysolutions-th') {
                    const psAmountInput = document.querySelector('[name="PaysolutionsAmount"]');
                    if (psAmountInput) {
                        psAmountInput.value = amount;
                    }
                } else if (selectedPaymentMethod === 'swiftgoldpay') {
                    const sgpAmountInput = document.querySelector('[name="SwiftGoldPayAmount"]');
                    if (sgpAmountInput) sgpAmountInput.value = amount;
                }
                
                // Remove active class from all buttons in the active form
                const formAmountBtns = activeForm ? activeForm.querySelectorAll('.amount-btn') : document.querySelectorAll('.amount-btn');
                formAmountBtns.forEach(btn => btn.classList.remove('active'));
                
                // Add active class to clicked button
                this.classList.add('active');
                
                // Update deposit button state
                updateDepositButtonState();
            });
        });

        // Flip back to front when focusing on amount input
        document.querySelector('[name="Amount"]').addEventListener('focus', function(e) {
            if (cardContainer) {
                cardContainer.classList.remove('flipped');
            }
        });

        // Validation functions - only show errors after user interaction
        function validateAmount(showErrors = true) {
            const selectedPaymentMethod = document.querySelector('input[name="PaymentMethod"]:checked')?.value;
            let amountInput;
            
            // Get the appropriate amount input based on selected payment method
            if (selectedPaymentMethod === 'luxtak') {
                amountInput = document.querySelector('[name="LuxtakAmount"]') || document.querySelector('[name="Amount"]');
            } else if (selectedPaymentMethod === 'smilepayz-th') {
                amountInput = document.querySelector('[name="SmilepayzAmount"]') || document.querySelector('[name="Amount"]');
            } else if (selectedPaymentMethod === 'paysolutions-th') {
                amountInput = document.querySelector('[name="PaysolutionsAmount"]') || document.querySelector('[name="Amount"]');
            } else if (selectedPaymentMethod === 'swiftgoldpay') {
                amountInput = document.querySelector('[name="SwiftGoldPayAmount"]') || document.querySelector('[name="Amount"]');
            } else {
                amountInput = document.querySelector('[name="Amount"]');
            }
            
            if (!amountInput) return false;
            
            const amountError = amountInput.parentElement.querySelector('.text-danger');
            const value = parseFloat(amountInput.value);
            
            if (!amountInput.value || value <= 0) {
                if (amountError && showErrors) {
                    amountError.textContent = 'Please enter a valid amount greater than 0.';
                    amountError.style.display = 'block';
                }
                return false;
            } else {
                if (amountError) amountError.style.display = 'none';
                return true;
            }
        }

        function validateCurrency(showErrors = true) {
            const selectedPaymentMethod = document.querySelector('input[name="PaymentMethod"]:checked')?.value;
            let currencySelect;
            
            // Get the appropriate currency select based on selected payment method
            if (selectedPaymentMethod === 'luxtak') {
                currencySelect = document.querySelector('[name="LuxtakCurrency"]') || document.querySelector('[name="Currency"]');
            } else if (selectedPaymentMethod === 'smilepayz-th') {
                currencySelect = document.querySelector('[name="SmilepayzCurrency"]') || document.querySelector('[name="Currency"]');
            } else if (selectedPaymentMethod === 'paysolutions-th') {
                currencySelect = document.querySelector('[name="PaysolutionsCurrency"]') || document.querySelector('[name="Currency"]');
            } else if (selectedPaymentMethod === 'swiftgoldpay') {
                currencySelect = document.querySelector('[name="SwiftGoldPayCurrency"]') || document.querySelector('[name="Currency"]');
            } else {
                currencySelect = document.querySelector('[name="Currency"]');
            }
            
            return currencySelect && currencySelect.value !== '';
        }

        function validateNameOnCard(showErrors = true) {
            const nameInput = document.querySelector('[name="NameOnCard"]');
            const nameError = nameInput.parentElement.querySelector('.text-danger');
            
            if (!nameInput.value.trim()) {
                if (nameError && showErrors) {
                    nameError.textContent = 'Cardholder name is required.';
                    nameError.style.display = 'block';
                }
                return false;
            } else {
                if (nameError) nameError.style.display = 'none';
                return true;
            }
        }

        function validateCardNumber(showErrors = true) {
            const cardInput = document.querySelector('[name="CardNumber"]');
            const cardError = cardInput.parentElement.querySelector('.text-danger');
            const value = cardInput.value.replace(/\s/g, '').replace(/[^0-9]/g, '');
            
            if (!value) {
                if (cardError && showErrors) {
                    cardError.textContent = 'Card number is required.';
                    cardError.style.display = 'block';
                }
                return false;
            }
            
            // Check length (13-19 digits for most cards)
            if (value.length < 13 || value.length > 19) {
                if (cardError && showErrors) {
                    cardError.textContent = 'Please enter a valid card number (13-19 digits).';
                    cardError.style.display = 'block';
                }
                return false;
            }
            
            // Enhanced card validation (includes Luhn + test pattern rejection + card type validation)
            if (!isValidCardNumber(value)) {
                if (cardError && showErrors) {
                    cardError.textContent = 'Please enter a valid credit card number.';
                    cardError.style.display = 'block';
                }
                return false;
            }
            
            if (cardError) {
                cardError.style.display = 'none';
            }
            return true;
        }

        // Enhanced card number validation
        function isValidCardNumber(cardNumber) {
            // First check if it passes Luhn algorithm
            if (!isValidLuhn(cardNumber)) {
                return false;
            }
            
            // Only reject obvious fake patterns that are clearly not real test cards
            const fakePatterns = [
                /^(1111\s*2222\s*3333\s*4444|1111222233334444)$/, // Mixed pattern like 1111 2222 3333 4444
                /^(1234\s*5678\s*9012\s*3456|1234567890123456)$/, // Sequential pattern
                /^(0000\s*0000\s*0000\s*0000|0000000000000000)$/, // All zeros
                /^(9999\s*9999\s*9999\s*9999|9999999999999999)$/, // All nines
            ];
            
            // Check against fake patterns only
            for (let pattern of fakePatterns) {
                if (pattern.test(cardNumber)) {
                    return false;
                }
            }
            
            // Check for valid card type prefixes
            const cardType = getCardType(cardNumber);
            if (!cardType) {
                return false;
            }
            
            return true;
        }
        
        // Get card type and validate prefix
        function getCardType(cardNumber) {
            const number = cardNumber.replace(/\s/g, '');
            
            // Visa: starts with 4, length 13, 16, or 19
            if (/^4/.test(number)) {
                if ([13, 16, 19].includes(number.length)) {
                    // Allow legitimate test cards like 4111111111111111
                    // Only reject obvious patterns like 4000000000000000
                    if (/^4000000000000000$/.test(number)) {
                        return null;
                    }
                    return 'visa';
                }
            }
            
            // Mastercard: starts with 5[1-5] or 2[2-7], length 16
            if ((/^5[1-5]/.test(number) || /^2[2-7]/.test(number)) && number.length === 16) {
                // Allow legitimate test cards like 5555555555554444
                return 'mastercard';
            }
            
            // American Express: starts with 34 or 37, length 15
            if (/^3[47]/.test(number) && number.length === 15) {
                return 'amex';
            }
            
            // Discover: starts with 6011, 622[1-9], 64[4-9], or 65, length 16
            if ((/^6011|^622[1-9]|^64[4-9]|^65/.test(number)) && number.length === 16) {
                return 'discover';
            }
            
            return null; // Unknown or invalid card type
        }

        // Luhn algorithm implementation
        function isValidLuhn(cardNumber) {
            let sum = 0;
            let shouldDouble = false;
            
            // Process digits from right to left
            for (let i = cardNumber.length - 1; i >= 0; i--) {
                let digit = parseInt(cardNumber.charAt(i));
                
                if (shouldDouble) {
                    digit *= 2;
                    if (digit > 9) {
                        digit -= 9; // or digit = digit - 9
                    }
                }
                
                sum += digit;
                shouldDouble = !shouldDouble;
            }
            
            return (sum % 10) === 0;
        }

        function validateExpirationDate(showErrors = true) {
            const expiryInput = document.querySelector('[name="ExpirationDate"]');
            const expiryError = expiryInput.parentElement.querySelector('.text-danger');
            const value = expiryInput.value;
            
            if (!value || value.length < 5) {
                if (expiryError && showErrors) {
                    expiryError.textContent = 'Expiration date is required (MM/YY).';
                    expiryError.style.display = 'block';
                }
                return false;
            }
            
            // Additional date validation
            const parts = value.split('/');
            if (parts.length !== 2) {
                if (expiryError && showErrors) {
                    expiryError.textContent = 'Please enter date in MM/YY format.';
                    expiryError.style.display = 'block';
                }
                return false;
            }
            
            const month = parseInt(parts[0]);
            const year = parseInt(parts[1]) + 2000; // Convert YY to YYYY
            const currentDate = new Date();
            const currentYear = currentDate.getFullYear();
            const currentMonth = currentDate.getMonth() + 1;
            
            // Check if month is valid
            if (month < 1 || month > 12) {
                if (expiryError && showErrors) {
                    expiryError.textContent = 'Please enter a valid month (01-12).';
                    expiryError.style.display = 'block';
                }
                return false;
            }
            
            // Check if date is not in the past
            if (year < currentYear || (year === currentYear && month < currentMonth)) {
                if (expiryError && showErrors) {
                    expiryError.textContent = 'Card has expired. Please use a valid card.';
                    expiryError.style.display = 'block';
                }
                return false;
            }
            
            if (expiryError) expiryError.style.display = 'none';
            return true;
        }

        function validateCVV(showErrors = true) {
            const cvvInput = document.querySelector('[name="CVV"]');
            const cvvError = cvvInput.parentElement.querySelector('.text-danger');
            const value = cvvInput.value;
            
            if (!value || value.length < 3 || value.length > 4) {
                if (cvvError && showErrors) {
                    cvvError.textContent = 'Please enter a valid CVV (3-4 digits).';
                    cvvError.style.display = 'block';
                }
                return false;
            } else {
                if (cvvError) cvvError.style.display = 'none';
                return true;
            }
        }

        // Check if all mandatory fields are valid and update deposit button state
        function updateDepositButtonState() {
            const depositBtn = document.getElementById('deposit-btn');
            
            // Get current payment method
            const selectedPaymentMethod = document.querySelector('input[name="PaymentMethod"]:checked').value;
            
            if (selectedPaymentMethod === 'card') {
                // For card payments, check all mandatory card fields (without showing errors)
                const isAmountValid = validateAmount(false);
                const isCurrencyValid = validateCurrency(false);
                const isCardNumberValid = validateCardNumber(false);
                const isNameValid = validateNameOnCard(false);
                const isExpiryValid = validateExpirationDate(false);
                const isCVVValid = validateCVV(false);
                
                const allValid = isAmountValid && isCurrencyValid && isCardNumberValid && 
                               isNameValid && isExpiryValid && isCVVValid;
                
                if (allValid) {
                    depositBtn.disabled = false;
                    depositBtn.classList.remove('disabled');
                    depositBtn.textContent = 'DEPOSIT';
                } else {
                    depositBtn.disabled = true;
                    depositBtn.classList.add('disabled');
                    depositBtn.textContent = 'DEPOSIT';
                }
            } else {
                // For other payment methods, only check amount and currency (without showing errors)
                const isAmountValid = validateAmount(false);
                const isCurrencyValid = validateCurrency(false);
                
                if (isAmountValid && isCurrencyValid) {
                    depositBtn.disabled = false;
                    depositBtn.classList.remove('disabled');
                    depositBtn.textContent = 'DEPOSIT';
                } else {
                    depositBtn.disabled = true;
                    depositBtn.classList.add('disabled');
                    depositBtn.textContent = 'DEPOSIT';
                }
            }
        }

        // Initialize validation on page load
        function initializeValidation() {
            // Hide all validation messages initially and clear any custom content
            document.querySelectorAll('.text-danger').forEach(error => {
                if (error) {
                    error.style.display = 'none';
                    error.textContent = ''; // Clear any existing content
                }
            });

            // Add event listeners for real-time validation with debouncing
            const amountInput = document.querySelector('[name="Amount"]');
            const luxtakAmountInput = document.querySelector('[name="LuxtakAmount"]');
            const smilepayzAmountInput = document.querySelector('[name="SmilepayzAmount"]');
            const currencySelect = document.querySelector('[name="Currency"]');
            const smilepayzCurrencySelect = document.querySelector('[name="SmilepayzCurrency"]');
            const sgpAmountInput = document.querySelector('[name="SwiftGoldPayAmount"]');
            const sgpCurrencySelect = document.querySelector('[name="SwiftGoldPayCurrency"]');
            const nameInput = document.querySelector('[name="NameOnCard"]');
            const cardInput = document.querySelector('[name="CardNumber"]');
            const expiryInput = document.querySelector('[name="ExpirationDate"]');
            const cvvInput = document.querySelector('[name="CVV"]');

            // Use setTimeout to prevent conflicts with jQuery validation
            if (amountInput) {
                amountInput.addEventListener('input', () => {
                    setTimeout(() => {
                        validateAmount(true); // Show errors during input
                        updateDepositButtonState();
                    }, 100);
                });
                amountInput.addEventListener('blur', () => {
                    setTimeout(() => {
                        validateAmount(true); // Show errors on blur
                        updateDepositButtonState();
                    }, 100);
                });
            }
            
            // Add event listeners for Luxtak amount input
            if (luxtakAmountInput) {
                luxtakAmountInput.addEventListener('input', () => {
                    setTimeout(() => {
                        validateAmount(true); // Show errors during input
                        updateDepositButtonState();
                    }, 100);
                });
                luxtakAmountInput.addEventListener('blur', () => {
                    setTimeout(() => {
                        validateAmount(true); // Show errors on blur
                        updateDepositButtonState();
                    }, 100);
                });
            }
            if (smilepayzAmountInput) {
                smilepayzAmountInput.addEventListener('input', () => {
                    setTimeout(() => {
                        validateAmount(true);
                        updateDepositButtonState();
                    }, 100);
                });
                smilepayzAmountInput.addEventListener('blur', () => {
                    setTimeout(() => {
                        validateAmount(true);
                        updateDepositButtonState();
                    }, 100);
                });
            }
            if (sgpAmountInput) {
                sgpAmountInput.addEventListener('input', () => {
                    setTimeout(() => { validateAmount(true); updateDepositButtonState(); }, 100);
                });
                sgpAmountInput.addEventListener('blur', () => {
                    setTimeout(() => { validateAmount(true); updateDepositButtonState(); }, 100);
                });
            }
            
            if (currencySelect) {
                currencySelect.addEventListener('change', () => {
                    setTimeout(() => {
                        updateDepositButtonState();
                    }, 100);
                });
            }
            if (smilepayzCurrencySelect) {
                smilepayzCurrencySelect.addEventListener('change', () => {
                    setTimeout(() => {
                        updateDepositButtonState();
                    }, 100);
                });
            }
            if (sgpCurrencySelect) {
                sgpCurrencySelect.addEventListener('change', () => {
                    setTimeout(() => { updateDepositButtonState(); }, 100);
                });
            }
            
            if (nameInput) {
                nameInput.addEventListener('input', () => {
                    setTimeout(() => {
                        validateNameOnCard(true); // Show errors during input
                        updateDepositButtonState();
                    }, 100);
                });
                nameInput.addEventListener('blur', () => {
                    setTimeout(() => {
                        validateNameOnCard(true); // Show errors on blur
                        updateDepositButtonState();
                    }, 100);
                });
            }
            
            if (cardInput) {
                cardInput.addEventListener('input', (e) => {
                    // First handle formatting
                    let value = e.target.value.replace(/\s/g, '').replace(/[^0-9]/gi, '');
                    let formattedValue = value.match(/.{1,4}/g)?.join(' ') || value;
                    e.target.value = formattedValue;
                    
                    // Update card display
                    const cardDisplay = document.getElementById('card-display');
                    if (cardDisplay) {
                        if (value.length > 0) {
                            let displayValue = '';
                            for (let i = 0; i < 16; i++) {
                                if (i < value.length) {
                                    displayValue += value[i];
                                } else {
                                    displayValue += '•';
                                }
                                if ((i + 1) % 4 === 0 && i < 15) {
                                    displayValue += ' ';
                                }
                            }
                            cardDisplay.textContent = displayValue;
                        } else {
                            cardDisplay.textContent = '•••• •••• •••• ••••';
                        }
                    }
                    
                    // Update card brand
                    updateCardBrand(value);
                    
                    // Then validate with delay
                    setTimeout(() => {
                        validateCardNumber(true); // Show errors during input
                        updateDepositButtonState();
                    }, 150);
                });
                cardInput.addEventListener('blur', () => {
                    setTimeout(() => {
                        validateCardNumber(true); // Show errors on blur
                        updateDepositButtonState();
                    }, 150);
                });
            }
            
            if (expiryInput) {
                expiryInput.addEventListener('input', (e) => {
                    // First handle formatting
                    let value = e.target.value.replace(/\D/g, '');
                    if (value.length >= 2) {
                        value = value.substring(0,2) + '/' + value.substring(2,4);
                    }
                    e.target.value = value;
                    
                    // Update expiry display
                    const expiryDisplay = document.getElementById('expiry-display');
                    if (expiryDisplay) {
                        if (value.length > 0) {
                            expiryDisplay.textContent = value;
                        } else {
                            expiryDisplay.textContent = 'MM/YY';
                        }
                    }
                    
                    // Then validate with delay
                    setTimeout(() => {
                        validateExpirationDate(true); // Show errors during input
                        updateDepositButtonState();
                    }, 150);
                });
                expiryInput.addEventListener('blur', () => {
                    setTimeout(() => {
                        validateExpirationDate(true); // Show errors on blur
                        updateDepositButtonState();
                    }, 150);
                });
            }
            
            if (cvvInput) {
                cvvInput.addEventListener('input', () => {
                    setTimeout(() => {
                        validateCVV(true); // Show errors during input
                        updateDepositButtonState();
                    }, 150);
                });
                cvvInput.addEventListener('blur', () => {
                    setTimeout(() => {
                        validateCVV(true); // Show errors on blur
                        updateDepositButtonState();
                    }, 150);
                });
            }
            
            // Add event listeners for payment method changes
            document.querySelectorAll('input[name="PaymentMethod"]').forEach(radio => {
                radio.addEventListener('change', () => {
                    setTimeout(() => {
                        updateDepositButtonState();
                    }, 100);
                });
            });
            
            // Initial deposit button state check
            updateDepositButtonState();
        }

        // Wait for DOM to be fully loaded
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', function() {
                initializeValidation();
                setTimeout(initializeCarousel, 200); // Increased delay
            });
        } else {
            initializeValidation();
            setTimeout(initializeCarousel, 200); // Increased delay
        }

        // Form submission handler for loading overlay and data preparation
        document.querySelector('.payment-form').addEventListener('submit', function(e) {
            const selectedPaymentMethod = document.querySelector('input[name="PaymentMethod"]:checked')?.value;
            
            // For PayPal payment, handle with AJAX
            if (selectedPaymentMethod === 'paypal') {
                e.preventDefault();
                handlePayPalPayment(e.target);
                return;
            }
            // For JM Financial payment, handle with AJAX
            if (selectedPaymentMethod === 'jmf') {
                e.preventDefault();
                handleJMFPayment(e.target);
                return;
            }
            // For Luxtak payment, handle with AJAX
            if (selectedPaymentMethod === 'luxtak') {
                e.preventDefault(); // Prevent default form submission
                handleLuxtakPayment(e.target);
                return;
            }
            // For Smilepayz TH payment, handle with AJAX
            if (selectedPaymentMethod === 'smilepayz-th') {
                e.preventDefault();
                handleSmilepayzPayment(e.target);
                return;
            }
            // For Paysolutions TH payment, handle with AJAX
            if (selectedPaymentMethod === 'paysolutions-th') {
                e.preventDefault();
                handlePaysolutionsPayment(e.target);
                return;
            }
            // For GPay Nuvei payment, intercept and show modal first
            if (selectedPaymentMethod === 'gpay') {
                e.preventDefault();
                showNuveiPreModal(e.target, 'ppp_GooglePay');
                return;
            }
            // For Apple Pay Nuvei payment, intercept and show modal first
            if (selectedPaymentMethod === 'apple-pay-nuvei') {
                e.preventDefault();
                showNuveiPreModal(e.target, 'ppp_ApplePay');
                return;
            }
            // For Apple Pay Nuvei IFrame payment
            if (selectedPaymentMethod === 'apple-pay-nuvei-iframe') {
                e.preventDefault();
                handleApplePayNuveiIFrame(e.target);
                return;
            }
            if (selectedPaymentMethod === 'swiftgoldpay') {
                e.preventDefault();
                handleSwiftGoldPayFlow(e.target);
                return;
            }
            if (selectedPaymentMethod === 'zmg') {
                e.preventDefault();
                handleZotaPayment(e.target);
                return;
            }
            
            // Check if form is valid before showing loading overlay
            const form = e.target;
            const isValid = form.checkValidity();
            
            if (isValid) {
                // Show loading overlay
                const loadingOverlay = document.getElementById('loading-overlay');
                if (loadingOverlay) {
                    loadingOverlay.style.display = 'flex';
                }
                
                // Disable submit button to prevent double submission
                const submitBtn = form.querySelector('.deposit-btn');
                if (submitBtn) {
                    submitBtn.disabled = true;
                    submitBtn.textContent = 'PROCESSING...';
                }
            }
    });
        // Zota handler (AJAX)
        async function handleZotaPayment(form){
            const amountInput = document.querySelector('[name="ZotaAmount"]') || document.querySelector('[name="Amount"]');
            const currencySelect = document.querySelector('[name="ZotaCurrency"]') || document.querySelector('[name="Currency"]');
            if(!amountInput?.value || !currencySelect?.value){ alert('Please provide amount and currency for Zota MG.'); return; }
            try{
                const antiForgery = document.querySelector('input[name="__RequestVerificationToken"]')?.value;
                const resp = await fetch('/Zota/Create', {
                    method:'POST',
                    headers:{ 'Content-Type':'application/json', ...(antiForgery? { 'RequestVerificationToken': antiForgery }: {}) },
                    credentials:'same-origin',
                    body: JSON.stringify({ amount: parseFloat(amountInput.value), currency: currencySelect.value })
                });
                const data = await resp.json();
                if(!data?.success || !data?.depositUrl){
                    showZotaModal(null, data?.message || 'Failed to get a deposit URL from Zota.');
                    return;
                }
                showZotaModal(data.depositUrl, null);
            } catch(err){
                console.error('Zota MG error', err);
                showZotaModal(null, 'Unexpected error. Please try again.');
            }
        }

        // Apple Pay Nuvei IFrame handler
        async function handleApplePayNuveiIFrame(form) {
            const amountInput = document.querySelector('[name="ApplePayIFrameAmount"]');
            const currencySelect = document.querySelector('[name="ApplePayIFrameCurrency"]');
            
            if (!amountInput?.value || !currencySelect?.value) {
                alert('Please provide amount and currency for Apple Pay.');
                return;
            }

            try {
                console.log('[Apple Pay IFrame] Starting payment flow for amount:', amountInput.value, 'currency:', currencySelect.value);

                // Hide the Deposit button
                const depositBtn = document.getElementById('deposit-btn');
                if (depositBtn) {
                    depositBtn.style.display = 'none';
                    console.log('[Apple Pay IFrame] Deposit button hidden');
                }

                // Show loading overlay
                const loadingOverlay = document.getElementById('loading-overlay');
                if (loadingOverlay) {
                    loadingOverlay.style.display = 'flex';
                    console.log('[Apple Pay IFrame] Loading overlay shown');
                }

                const formData = new FormData();
                formData.append('amount', amountInput.value);
                formData.append('currency', currencySelect.value);
                const antiForgeryToken = document.querySelector('input[name="__RequestVerificationToken"]');
                if (antiForgeryToken) formData.append('__RequestVerificationToken', antiForgeryToken.value);

                // Call backend to get the iframe URL
                console.log('[Apple Pay IFrame] Calling backend: /Nuvei/ApplePay/GetIFrameUrl');
                const resp = await fetch('/Nuvei/ApplePay/GetIFrameUrl', {
                    method: 'POST',
                    body: formData,
                    credentials: 'same-origin'
                });

                const data = await resp.json();
                console.log('[Apple Pay IFrame] Backend response:', {
                    success: data.success,
                    hasIframeUrl: !!data.iframeUrl,
                    iframeUrlLength: data.iframeUrl?.length,
                    error: data.error
                });

                if (loadingOverlay) loadingOverlay.style.display = 'none';

                if (!data.success || !data.iframeUrl) {
                    console.error('[Apple Pay IFrame] Backend returned error or no URL:', data.error);
                    alert('Failed to generate Apple Pay payment form: ' + (data.error || 'Unknown error'));
                    return;
                }

                // Show iframe container
                const iframeContainer = document.getElementById('apple-pay-nuvei-iframe-container');
                const iframe = document.getElementById('nuvei-apple-pay-iframe');
                
                if (!iframeContainer || !iframe) {
                    console.error('[Apple Pay IFrame] IFrame container or iframe element not found');
                    alert('Payment form container not found on page');
                    return;
                }

                console.log('[Apple Pay IFrame] Setting iframe src to Nuvei URL (length: ' + data.iframeUrl.length + ')');
                
                // Load the URL in the iframe
                iframe.src = data.iframeUrl;
                iframe.onload = function() {
                    console.log('[Apple Pay IFrame] IFrame loaded successfully');
                };
                iframe.onerror = function(err) {
                    console.error('[Apple Pay IFrame] IFrame failed to load:', err);
                };
                
                // Make container visible
                iframeContainer.style.display = 'block';
                iframeContainer.style.height = '600px';
                iframeContainer.style.border = '1px solid #d3dce6';
                iframeContainer.style.backgroundColor = '#f5f5f5';
                iframeContainer.style.marginTop = '20px';
                
                console.log('[Apple Pay IFrame] IFrame container displayed');
                
                // Scroll to the iframe
                setTimeout(() => {
                    iframeContainer.scrollIntoView({ behavior: 'smooth', block: 'center' });
                    console.log('[Apple Pay IFrame] Scrolled to iframe');
                }, 100);
            } catch (err) {
                console.error('[Apple Pay IFrame] Error:', err);
                const loadingOverlay = document.getElementById('loading-overlay');
                if (loadingOverlay) loadingOverlay.style.display = 'none';
                alert('Error initiating Apple Pay payment: ' + err.message);
            }
        }

        // SwiftGoldPay flow: get token + banks on selection, then create customer and deposit on submit with modal
        async function ensureSwiftGoldPayInitialized() {
            const select = document.getElementById('SwiftGoldPayBankSelect');
            if (!select || select.options.length > 1) return; // Already loaded
            try {
                const resp = await fetch('/SwiftGoldPay/Init', { method: 'GET', credentials: 'same-origin' });
                const data = await resp.json();
                if (!data.success) {
                    const err = document.getElementById('SwiftGoldPayBanksError');
                    if (err) { err.style.display = 'block'; err.textContent = data.error || 'Failed to get the list of banks!'; }
                    select.innerHTML = '<option value="">No banks available</option>';
                    return;
                }
                window._sgpToken = data.token; // cache in window
                select.innerHTML = '<option value="">Select your bank</option>';
                (data.banks || []).forEach(b => {
                    const opt = document.createElement('option');
                    opt.value = b.code;
                    opt.textContent = b.name_en || b.code;
                    select.appendChild(opt);
                });
            } catch (e) {
                const err = document.getElementById('SwiftGoldPayBanksError');
                if (err) { err.style.display = 'block'; err.textContent = 'Failed to get the list of banks! ' + (e.message||''); }
                select.innerHTML = '<option value="">No banks available</option>';
            }
        }

        // Hook initialization when selecting the SGP tab
        document.getElementById('swiftgoldpay')?.addEventListener('change', ensureSwiftGoldPayInitialized);

        // Modal for SwiftGoldPay
    function showSwiftGoldPayModal(onOk) {
            const modal = document.getElementById('luxtak-modal');
            const titleEl = document.getElementById('luxtak-modal-title');
            const msgEl = document.getElementById('luxtak-modal-message');
            const okBtn = document.getElementById('luxtak-ok-btn');
            const cancelBtn = document.getElementById('luxtak-cancel-btn');
            if (!modal || !titleEl || !msgEl || !okBtn || !cancelBtn) return;
            titleEl.textContent = 'SwiftGoldPay';
            msgEl.innerHTML = '<img src="https://swiftgoldpay.com/static/media/logo.1e15471715130144e5d8.png" alt="SwiftGoldPay" width="80" style="vertical-align:middle;margin-right:8px;object-fit:contain;"> SwiftGoldPay will open in a new tab. Continue?';
            okBtn.style.display = 'inline-block';
            okBtn.textContent = 'OK';
            okBtn.onclick = () => { modal.style.display = 'none'; onOk && onOk(); };
            cancelBtn.textContent = 'Cancel';
            cancelBtn.onclick = () => { modal.style.display = 'none'; };
            modal.style.display = 'flex';
        }

    async function handleSwiftGoldPayFlow(form) {
            const amountInput = document.querySelector('[name="SwiftGoldPayAmount"]');
            const currencySelect = document.querySelector('[name="SwiftGoldPayCurrency"]');
            const bankSel = document.getElementById('SwiftGoldPayBankSelect');
            const bankAcc = document.getElementById('SwiftGoldPayBankAccount');
            if (!amountInput?.value || !currencySelect?.value) { alert('Please provide amount and currency for SwiftGoldPay.'); return; }
            await ensureSwiftGoldPayInitialized();
            if (!window._sgpToken) {
                const err = document.getElementById('SwiftGoldPayBanksError');
                if (err) { err.style.display = 'block'; err.textContent = 'Failed to get the bearer token!'; }
                return;
            }
            if (!bankSel?.value) { alert('Please select your bank.'); return; }
            if (!bankAcc?.value) { alert('Please enter your bank account number.'); return; }

            showSwiftGoldPayModal(async () => {
                // Open a new tab immediately to avoid popup blockers, then stream updates
                const popup = window.open('', '_blank');
                if (!popup) { alert('Popup blocked. Please allow popups for this site.'); return; }
                popup.document.write('<html><head><title>SwiftGoldPay</title><style>body{font-family:Arial,sans-serif;padding:16px;}code{white-space:pre-wrap;display:block;background:#f5f5f5;padding:8px;border:1px solid #ddd;border-radius:4px;} .ok{color:#16a34a} .err{color:#b91c1c;font-weight:700}</style></head><body><h3><img src="https://swiftgoldpay.com/static/media/logo.1e15471715130144e5d8.png" alt="SwiftGoldPay" width="90" style="vertical-align:middle;margin-right:10px;object-fit:contain;"/>Initializing SwiftGoldPay...</h3><p id="sgp-status">Requesting token and banks...</p><div id="sgp-error"></div></body></html>');
                popup.document.close();
                try {
                    // Create/Retrieve customer
                    const token = document.querySelector('input[name="__RequestVerificationToken"]')?.value;
                    // First ensure we have a token/banks from init if not present already
                    if (!window._sgpToken) {
                        popup.document.getElementById('sgp-status')?.insertAdjacentText('beforeend', ' (refreshing token)...');
                        await ensureSwiftGoldPayInitialized();
                    }
                    const resp1 = await fetch('/SwiftGoldPay/CreateCustomer', {
                        method: 'POST', credentials: 'same-origin', headers: { 'Content-Type': 'application/json', ...(token? { 'RequestVerificationToken': token } : {}) },
                        body: JSON.stringify({ token: window._sgpToken, bankCode: bankSel.value, bankAccountNumber: bankAcc.value })
                    });
                    const data1 = await resp1.json();
                    if (!data1.success) {
                        const err = document.getElementById('SwiftGoldPayBanksError');
                        if (err) { err.style.display = 'block'; err.textContent = data1.error || 'Failed to create or retrieve the customer!'; }
                        const errDiv = popup.document.getElementById('sgp-error');
                        if (errDiv) errDiv.innerHTML = '<div class="err">'+escapeHtml(data1.error||'Customer creation failed')+'</div>';
                        return;
                    }
                    const customerId = data1.customerId;
                    const statusEl = popup.document.getElementById('sgp-status');
                    if (statusEl) statusEl.textContent = 'Customer created. Creating deposit...';
                    // Final deposit
                    const resp2 = await fetch('/SwiftGoldPay/CreateDeposit', {
                        method: 'POST', credentials: 'same-origin', headers: { 'Content-Type': 'application/json', ...(token? { 'RequestVerificationToken': token } : {}) },
                        body: JSON.stringify({ token: window._sgpToken, customerId, amount: parseFloat(amountInput.value) })
                    });
                    const data2 = await resp2.json();
                    if (!data2.success) {
                        const err = document.getElementById('SwiftGoldPayBanksError');
                        if (err) { err.style.display = 'block'; err.textContent = data2.error || 'Deposit failed!'; }
                        const errDiv = popup.document.getElementById('sgp-error');
                        if (errDiv) errDiv.innerHTML = '<div class="err">'+escapeHtml(data2.error||'Deposit failed')+'</div>';
                        return;
                    }
                    // Render QR code in the popup tab
                    const payload = data2?.data?.data || data2?.data || {};
                    let b64 = payload.base64 || '';
                    // If base64 doesn't start with data:image, add the prefix
                    if (b64 && !b64.startsWith('data:')) {
                        b64 = 'data:image/png;base64,' + b64;
                    }
                    const refNo = payload.ref_no || '';
                    const doc = popup.document;
                    
                    // Add CSS styling
                    const style = doc.createElement('style');
                    style.textContent = `
                        * { margin: 0; padding: 0; box-sizing: border-box; }
                        body { 
                            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
                            padding: 40px 20px; 
                            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
                            min-height: 100vh;
                            display: flex;
                            align-items: center;
                            justify-content: center;
                        }
                        .container { 
                            max-width: 700px; 
                            width: 100%;
                            margin: 0 auto; 
                            background: white; 
                            padding: 40px; 
                            border-radius: 16px; 
                            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
                        }
                        h3 { 
                            color: #2d3748; 
                            margin-bottom: 10px; 
                            font-size: 28px;
                            text-align: center;
                            display: flex;
                            align-items: center;
                            justify-content: center;
                            gap: 12px;
                        }
                        .instruction { 
                            font-size: 18px; 
                            color: #4a5568; 
                            margin: 25px 0 35px; 
                            font-weight: 500;
                            text-align: center;
                        }
                        .qr-wrapper {
                            text-align: center;
                            margin-bottom: 30px;
                        }
                        .qr-image { 
                            width: 240px; 
                            height: 240px; 
                            margin: 0 auto; 
                            display: inline-block; 
                            border: 3px solid #e2e8f0; 
                            border-radius: 12px;
                            padding: 10px;
                            background: white;
                            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
                        }
                        .button-wrapper {
                            text-align: center;
                            margin-bottom: 20px;
                        }
                        .check-btn { 
                            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
                            color: white; 
                            border: none; 
                            padding: 14px 40px; 
                            font-size: 16px; 
                            font-weight: 600;
                            border-radius: 8px; 
                            cursor: pointer; 
                            transition: all 0.3s ease;
                            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.4);
                        }
                        .check-btn:hover { 
                            transform: translateY(-2px);
                            box-shadow: 0 6px 20px rgba(102, 126, 234, 0.6);
                        }
                        .check-btn:active {
                            transform: translateY(0);
                        }
                        .error { 
                            color: #e53e3e; 
                            font-weight: bold; 
                            margin: 20px 0; 
                            padding: 16px; 
                            background: #fff5f5; 
                            border-radius: 8px; 
                            border-left: 4px solid #e53e3e;
                            display: none; 
                        }
                        .table-wrap { 
                            margin-top: 30px; 
                            display: none;
                            overflow-x: auto;
                        }
                        table { 
                            width: 100%; 
                            border-collapse: separate;
                            border-spacing: 0;
                            background: white;
                            border-radius: 8px;
                            overflow: hidden;
                            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
                        }
                        th, td { 
                            padding: 16px; 
                            text-align: left;
                        }
                        th { 
                            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
                            font-weight: 600; 
                            color: white;
                            font-size: 14px;
                            text-transform: uppercase;
                            letter-spacing: 0.5px;
                        }
                        td {
                            color: #4a5568;
                            border-bottom: 1px solid #e2e8f0;
                            font-size: 14px;
                        }
                        tbody tr:last-child td {
                            border-bottom: none;
                        }
                        tbody tr { 
                            transition: background 0.2s ease;
                        }
                        tbody tr:hover { 
                            background: #f7fafc;
                        }
                    `;
                    doc.head.appendChild(style);
                    
                    // Build the HTML
                    doc.body.innerHTML = `
                        <div class="container">
                            <h3>
                                <img src="https://swiftgoldpay.com/static/media/logo.1e15471715130144e5d8.png" alt="SwiftGoldPay" width="90" style="object-fit:contain;"/>
                                Deposit Created
                            </h3>
                            <p class="instruction">Please scan this code to finish your deposit.</p>
                            <div class="qr-wrapper">
                                <img class="qr-image" id="sgp-qr" src="${b64 || ''}" alt="QR Code" />
                            </div>
                            <div class="button-wrapper">
                                <button class="check-btn" id="check-status-btn">Check Deposit Status</button>
                            </div>
                            <div class="error" id="status-error"></div>
                            <div class="table-wrap" id="table-wrap">
                                <table>
                                    <thead>
                                        <tr>
                                            <th>UID</th>
                                            <th>Ref No</th>
                                            <th>Amount</th>
                                            <th>Currency</th>
                                            <th>Process Type</th>
                                            <th>Status</th>
                                        </tr>
                                    </thead>
                                    <tbody id="status-tbody"></tbody>
                                </table>
                            </div>
                        </div>
                    `;
                    
                    // Store data for status check
                    popup._sgpToken = window._sgpToken;
                    popup._sgpRefNo = refNo;
                    popup._sgpCurrency = (document.querySelector('[name="SwiftGoldPayCurrency"]')?.value) || 'THB';
                    
                    // Wire up the status check button
                    const checkBtn = doc.getElementById('check-status-btn');
                    if (checkBtn) {
                        checkBtn.addEventListener('click', async function() {
                            const errEl = doc.getElementById('status-error');
                            const tableWrap = doc.getElementById('table-wrap');
                            const tbody = doc.getElementById('status-tbody');
                            
                            try {
                                const token = popup._sgpToken;
                                const refNo = popup._sgpRefNo;
                                const currency = popup._sgpCurrency;
                                
                                if (!token || !refNo) {
                                    if (errEl) { errEl.style.display = 'block'; errEl.textContent = 'Missing token or reference number.'; }
                                    return;
                                }
                                
                                if (errEl) { errEl.style.display = 'none'; errEl.textContent = ''; }
                                if (tableWrap) tableWrap.style.display = 'none';
                                
                                const url = window.location.origin + `/SwiftGoldPay/TxStatus?token=${encodeURIComponent(token)}&refNo=${encodeURIComponent(refNo)}&currency=${encodeURIComponent(currency)}`;
                                const resp = await fetch(url, { method: 'GET', credentials: 'same-origin' });
                                const data = await resp.json();
                                
                                if (!data.success) {
                                    if (errEl) { 
                                        errEl.style.display = 'block'; 
                                        errEl.textContent = data.error || 'Failed to get the deposit status!'; 
                                    }
                                    return;
                                }
                                
                                const items = data.items || [];
                                if (tbody) tbody.innerHTML = '';
                                
                                items.forEach(it => {
                                    const tr = doc.createElement('tr');
                                    const uid = (it?.uid ?? '').toString();
                                    const ref_no = (it?.ref_no ?? it?.refNo ?? '').toString();
                                    const amount = (it?.amount ?? '').toString();
                                    const currency = (it?.currency ?? '').toString();
                                    const process_type = (it?.process_type ?? it?.processType ?? '').toString();
                                    const status = (it?.status ?? '').toString();
                                    
                                    const escapeHtml = (text) => {
                                        const map = {'&': '&amp;','<': '&lt;','>': '&gt;','"': '&quot;',"'": '&#039;'};
                                        return text.replace(/[&<>"']/g, m => map[m]);
                                    };
                                    
                                    tr.innerHTML = `<td>${escapeHtml(uid)}</td>` +
                                                   `<td>${escapeHtml(ref_no)}</td>` +
                                                   `<td>${escapeHtml(amount)}</td>` +
                                                   `<td>${escapeHtml(currency)}</td>` +
                                                   `<td>${escapeHtml(process_type)}</td>` +
                                                   `<td>${escapeHtml(status)}</td>`;
                                    tbody.appendChild(tr);
                                });
                                
                                if (tableWrap) tableWrap.style.display = 'block';
                            } catch (e) {
                                if (errEl) { 
                                    errEl.style.display = 'block'; 
                                    errEl.textContent = 'Failed to get the deposit status! ' + (e.message || ''); 
                                }
                            }
                        });
                    }
                } catch (e) {
                    const err = document.getElementById('SwiftGoldPayBanksError');
                    if (err) { err.style.display = 'block'; err.textContent = 'Unexpected error: ' + (e.message||''); }
                    try {
                        const errDiv = popup.document.getElementById('sgp-error');
                        if (errDiv) errDiv.innerHTML = '<div class="err">'+escapeHtml(e.message||'Unexpected error')+'</div>';
                    } catch {}
                }
            });
        }

        function showZotaModal(depositUrl, errMsg){
            const modal = document.getElementById('zota-modal');
            if(!modal){ if(depositUrl) window.open(depositUrl,'_blank','noopener'); return; }
            const msg = document.getElementById('zota-modal-message');
            const err = document.getElementById('zota-error');
            const ok = document.getElementById('zota-ok-btn');
            const cancel = document.getElementById('zota-cancel-btn');
            err.style.display = errMsg ? 'block' : 'none';
            err.textContent = errMsg || '';
            msg.textContent = errMsg ? 'Could not open Zota MG' : 'Zota MG will open in a new tab. Continue?';
            ok.onclick = () => { modal.style.display = 'none'; if(depositUrl){ window.open(depositUrl,'_blank','noopener'); }};
            cancel.onclick = () => { modal.style.display = 'none'; };
            modal.style.display = 'flex';
        }

        window.handleZotaPayment = handleZotaPayment;
        window.showZotaModal = showZotaModal;

        // Show Nuvei HPP in modal
        async function showNuveiPreModal(form, paymentMethod = 'ppp_GooglePay') {
            const isApplePay = paymentMethod === 'ppp_ApplePay';
            const amountInput = document.querySelector(`[name="${isApplePay ? 'ApplePayAmount' : 'GPayAmount'}"]`);
            const currencySelect = document.querySelector(`[name="${isApplePay ? 'ApplePayCurrency' : 'GPayCurrency'}"]`);
            const methodLabel = isApplePay ? 'Apple Pay' : 'Google Pay';
            
            if (!amountInput?.value || !currencySelect?.value) {
                alert(`Please provide amount and currency for ${methodLabel} Nuvei.`);
                return;
            }

            // Show loading overlay
            const loadingOverlay = document.getElementById('loading-overlay');
            if (loadingOverlay) loadingOverlay.style.display = 'flex';

            try {
                const formData = new FormData();
                formData.append('amount', amountInput.value);
                formData.append('currency', currencySelect.value);
                formData.append('paymentMethod', paymentMethod);
                const antiForgeryToken = document.querySelector('input[name="__RequestVerificationToken"]');
                if (antiForgeryToken) formData.append('__RequestVerificationToken', antiForgeryToken.value);
                
                const resp = await fetch('/Nuvei/Create', { method:'POST', body: formData, headers: { 'X-Requested-With':'XMLHttpRequest' } });
                
                if(!resp.ok){
                    if (loadingOverlay) loadingOverlay.style.display = 'none';
                    alert('Failed to create Nuvei session. HTTP ' + resp.status);
                    return;
                }
                
                const data = await resp.json();
                console.debug('Nuvei Create response:', data);
                
                if(!data.success || !data.formUrl){
                    if (loadingOverlay) loadingOverlay.style.display = 'none';
                    alert('Nuvei form creation failed: ' + (data.error || 'Unknown error'));
                    return;
                }
                
                // Build GET URL with query parameters
                const params = new URLSearchParams();
                (data.fields||[]).forEach(field => {
                    const key = field.key || field.Key;
                    const val = field.value || field.Value;
                    if (key && val) {
                        params.append(key, val);
                    }
                });
                
                // Construct the full GET URL
                const nuveiUrl = data.formUrl + '?' + params.toString();
                console.debug('Loading Nuvei HPP URL:', nuveiUrl);
                
                // Hide loading overlay
                if (loadingOverlay) loadingOverlay.style.display = 'none';
                
                // For Apple Pay: show confirmation modal
                if (isApplePay) {
                    const apModal = document.getElementById('applepay-nuvei-modal');
                    const apOkBtn = document.getElementById('applepay-nuvei-ok-btn');
                    const apCancelBtn = document.getElementById('applepay-nuvei-cancel-btn');
                    
                    if (!apModal || !apOkBtn || !apCancelBtn) return;
                    
                    apModal.style.display = 'flex';
                    
                    // OK button - open in new tab
                    apOkBtn.onclick = () => {
                        apModal.style.display = 'none';
                        window.open(nuveiUrl, '_blank', 'noopener,noreferrer');
                    };
                    
                    // Cancel button - close modal
                    apCancelBtn.onclick = () => {
                        apModal.style.display = 'none';
                    };
                } else {
                    // Use iframe modal for Google Pay
                    const modal = document.getElementById('nuvei-modal');
                    const closeBtn = document.getElementById('nuvei-close-btn');
                    const iframe = document.getElementById('nuvei-iframe');
                    
                    if (!modal || !iframe) return;
                    
                    modal.style.display = 'flex';
                    
                    // Find back_url from fields
                    const backUrlField = data.fields?.find(f => (f.key || f.Key) === 'back_url');
                    const backUrl = backUrlField ? (backUrlField.value || backUrlField.Value) : null;
                    
                    // Set up close button to navigate to back_url
                    closeBtn.onclick = () => {
                        modal.style.display = 'none';
                        if (backUrl) {
                            window.location.href = backUrl;
                        }
                    };
                    
                    // Load URL in iframe
                    iframe.src = nuveiUrl;
                }
                
            } catch(err) {
                console.error('Nuvei create error', err);
                alert('Error initiating Nuvei request: ' + err.message);
                modal.style.display = 'none';
            }
        }

        // Deprecated - kept for compatibility but no longer used
        async function initiateNuveiRequest(form, paymentMethod = 'ppp_GooglePay') {
            // This function is now deprecated - showNuveiPreModal handles everything
            console.warn('initiateNuveiRequest is deprecated');
        }
        
        function escapeHtml(str){ return str.replace(/[&<>"']/g, c=>({"&":"&amp;","<":"&lt;",">":"&gt;","\"":"&quot;","'":"&#39;"}[c])); }

        // ==== Missing Functions Implemented ====
        // Show Luxtak modal (success: auto-redirect to webUrl, error: display message)
    function showLuxtakModal(content, isSuccess, providerName = 'Luxtak') {
            const modal = document.getElementById('luxtak-modal');
            if (!modal) { console.warn('Luxtak modal element not found'); if(isSuccess){ window.location.href = content; } return; }
            const titleEl = document.getElementById('luxtak-modal-title');
            const msgEl = document.getElementById('luxtak-modal-message');
            const okBtn = document.getElementById('luxtak-ok-btn');
            const cancelBtn = document.getElementById('luxtak-cancel-btn');
            if (!titleEl || !msgEl || !okBtn || !cancelBtn) { if(isSuccess){ window.location.href = content; } return; }

            if (isSuccess) {
                titleEl.textContent = `${providerName} Payment`;
        const webUrl = content; // Payment destination
        // PayPal opens in new tab, others open in same tab for redirect flow
        const openInNewTab = providerName === 'PayPal';
        msgEl.innerHTML = `Ready to redirect to the ${providerName} payment page.<br><small>Click OK to continue${openInNewTab ? ' in a new tab' : ' in this tab'} or Cancel to abort.</small>`;
        okBtn.style.display = 'inline-block';
        okBtn.textContent = 'OK';
        okBtn.onclick = () => { 
            modal.style.display = 'none'; 
            if (openInNewTab) {
                window.open(webUrl, '_blank', 'noopener,noreferrer');
            } else {
                window.location.href = webUrl;
            }
        };
        cancelBtn.textContent = 'Cancel';
        cancelBtn.onclick = () => { modal.style.display = 'none'; };
        modal.style.display = 'flex';
            } else {
                titleEl.textContent = `${providerName} Payment Error`;
                msgEl.textContent = content || 'Payment failed';
                okBtn.style.display = 'inline-block';
                okBtn.textContent = 'OK';
                okBtn.onclick = () => { modal.style.display = 'none'; };
                cancelBtn.textContent = 'Close';
                cancelBtn.onclick = () => { modal.style.display = 'none'; };
                modal.style.display = 'flex';
            }
        }

        // Smilepayz handler (AJAX similar to Luxtak)
        async function handleLuxtakPayment(form) {
            const amountInput = document.querySelector('[name="LuxtakAmount"]');
            const currencySelect = document.querySelector('[name="LuxtakCurrency"]');
            if (!amountInput?.value || !currencySelect?.value) {
                alert('Please fill in amount and currency for Luxtak payment');
                return;
            }
            const loadingOverlay = document.getElementById('loading-overlay');
            if (loadingOverlay) loadingOverlay.style.display = 'flex';
            try {
                const formData = new FormData();
                formData.append('PaymentMethod', 'luxtak');
                formData.append('Amount', amountInput.value);
                formData.append('Currency', currencySelect.value);
                const token = document.querySelector('input[name="__RequestVerificationToken"]');
                if (token) formData.append('__RequestVerificationToken', token.value);
                const resp = await fetch('/Payment', { method: 'POST', headers: { 'X-Requested-With': 'XMLHttpRequest' }, credentials: 'same-origin', body: formData });
                if (!resp.ok) throw new Error('HTTP ' + resp.status);
                const text = await resp.text();
                let data; try { data = JSON.parse(text); } catch { throw new Error('Invalid JSON from server'); }
                if (loadingOverlay) loadingOverlay.style.display = 'none';
                if (data.success && data.paymentUrl) {
                    // Show confirmation modal with redirect to Luxtak
                    showLuxtakModal(data.paymentUrl, true);
                } else {
                    showLuxtakModal(data.error || 'Luxtak payment failed', false);
                }
            } catch (err) {
                console.error('Luxtak payment error', err);
                if (loadingOverlay) loadingOverlay.style.display = 'none';
                showLuxtakModal('Network error during Luxtak payment. Please try again.', false);
            }
        }

        async function handlePayPalPayment(form) {
            const amountInput = document.querySelector('[name="PayPalAmount"]');
            const currencySelect = document.querySelector('[name="PayPalCurrency"]');
            if (!amountInput?.value || !currencySelect?.value) {
                alert('Please fill in amount and currency for PayPal payment');
                return;
            }
            const loadingOverlay = document.getElementById('loading-overlay');
            if (loadingOverlay) loadingOverlay.style.display = 'flex';
            try {
                const formData = new FormData();
                formData.append('PaymentMethod', 'paypal');
                formData.append('Amount', amountInput.value);
                formData.append('Currency', currencySelect.value);
                const token = document.querySelector('input[name="__RequestVerificationToken"]');
                if (token) formData.append('__RequestVerificationToken', token.value);
                const resp = await fetch('/Payment', { method: 'POST', headers: { 'X-Requested-With': 'XMLHttpRequest' }, credentials: 'same-origin', body: formData });
                if (!resp.ok) throw new Error('HTTP ' + resp.status);
                const text = await resp.text();
                let data; try { data = JSON.parse(text); } catch { throw new Error('Invalid JSON from server'); }
                if (loadingOverlay) loadingOverlay.style.display = 'none';
                if (data.success && data.paymentUrl) {
                    // Show confirmation modal with redirect to PayPal
                    showLuxtakModal(data.paymentUrl, true, 'PayPal');
                } else {
                    showLuxtakModal(data.error || 'PayPal payment failed', false, 'PayPal');
                }
            } catch (err) {
                console.error('PayPal payment error', err);
                if (loadingOverlay) loadingOverlay.style.display = 'none';
                showLuxtakModal('Network error during PayPal payment. Please try again.', false, 'PayPal');
            }
        }

        async function handleJMFPayment(form) {
            const amountInput = document.querySelector('[name="JMFAmount"]');
            const currencySelect = document.querySelector('[name="JMFCurrency"]');
            const customerName = document.querySelector('[name="JMFCustomerName"]');
            const customerEmail = document.querySelector('[name="JMFCustomerEmail"]');

            if (!amountInput?.value || !currencySelect?.value) {
                alert('Please fill in amount and currency for JM Financial payment');
                return;
            }

            if (!customerName?.value || !customerEmail?.value) {
                alert('Please fill in your name and email for JM Financial payment');
                return;
            }

            const loadingOverlay = document.getElementById('loading-overlay');
            if (loadingOverlay) loadingOverlay.style.display = 'flex';

            try {
                const formData = new FormData();
                formData.append('amount', amountInput.value);
                formData.append('currency', currencySelect.value);
                formData.append('customerName', customerName.value);
                formData.append('customerEmail', customerEmail.value);

                const token = document.querySelector('input[name="__RequestVerificationToken"]');
                if (token) formData.append('__RequestVerificationToken', token.value);

                const resp = await fetch('/JMF/Create', {
                    method: 'POST',
                    headers: { 'X-Requested-With': 'XMLHttpRequest' },
                    credentials: 'same-origin',
                    body: formData
                });

                if (!resp.ok) throw new Error('HTTP ' + resp.status);

                const text = await resp.text();
                let data;
                try {
                    data = JSON.parse(text);
                } catch {
                    throw new Error('Invalid JSON from server');
                }

                if (loadingOverlay) loadingOverlay.style.display = 'none';

                if (data.success && data.paymentUrl) {
                    // Show confirmation modal with redirect to JM Financial
                    showLuxtakModal(data.paymentUrl, true, 'JM Financial');
                } else {
                    showLuxtakModal(data.error || 'JM Financial payment failed', false, 'JM Financial');
                }
            } catch (err) {
                console.error('JM Financial payment error', err);
                if (loadingOverlay) loadingOverlay.style.display = 'none';
                showLuxtakModal('Network error during JM Financial payment. Please try again.', false, 'JM Financial');
            }
        }

        async function handleSmilepayzPayment(form) {
            const amountInput = document.querySelector('[name="SmilepayzAmount"]');
            const currencySelect = document.querySelector('[name="SmilepayzCurrency"]');
            if (!amountInput?.value || !currencySelect?.value) {
                alert('Please fill in amount and currency for Smilepayz payment');
                return;
            }
            const loadingOverlay = document.getElementById('loading-overlay');
            if (loadingOverlay) loadingOverlay.style.display = 'flex';
            try {
                const formData = new FormData();
                formData.append('PaymentMethod', 'smilepayz-th');
                formData.append('Amount', amountInput.value);
                formData.append('Currency', currencySelect.value);
                const token = document.querySelector('input[name="__RequestVerificationToken"]');
                if (token) formData.append('__RequestVerificationToken', token.value);
                const resp = await fetch('/Payment', { method: 'POST', headers: { 'X-Requested-With': 'XMLHttpRequest' }, credentials: 'same-origin', body: formData });
                if (!resp.ok) throw new Error('HTTP ' + resp.status);
                const text = await resp.text();
                let data; try { data = JSON.parse(text); } catch { throw new Error('Invalid JSON from server'); }
                if (loadingOverlay) loadingOverlay.style.display = 'none';
                if (data.success && data.paymentUrl) {
                    // Show confirmation modal (reuse Luxtak modal styling)
                    showLuxtakModal(data.paymentUrl, true, 'Smilepayz');
                } else {
                    showLuxtakModal(data.error || 'Smilepayz payment failed', false, 'Smilepayz');
                }
            } catch (err) {
                console.error('Smilepayz payment error', err);
                if (loadingOverlay) loadingOverlay.style.display = 'none';
                showLuxtakModal('Network error during Smilepayz payment. Please try again.', false, 'Smilepayz');
            }
        }

        // Paysolutions payment handler: open modal immediately, fetch, then show QR
        async function handlePaysolutionsPayment(form) {
            const amountInput = document.querySelector('[name="PaysolutionsAmount"]');
            const currencySelect = document.querySelector('[name="PaysolutionsCurrency"]');

            if (!amountInput?.value || !currencySelect?.value) {
                alert('Please fill in amount and currency for Paysolutions payment');
                return;
            }

            const modal = document.getElementById('paysolutions-modal');
            if (!modal) return;

            // Setup modal UI to loading state
            const okBtn = document.getElementById('paysolutions-ok-btn');
            const dataContainer = document.getElementById('paysolutions-data-container');
            const messageContainer = document.getElementById('paysolutions-modal-message');

            // Reset listeners to avoid duplicates
            const newOkBtn = okBtn.cloneNode(true);
            okBtn.parentNode.replaceChild(newOkBtn, okBtn);

            // Show modal right away in loading state
            if (messageContainer) {
                messageContainer.textContent = 'Generating Paysolutions QR... Please wait.';
                messageContainer.style.display = 'block';
            }
            if (dataContainer) dataContainer.style.display = 'none';
            newOkBtn.disabled = true;
            newOkBtn.textContent = 'Please wait...';
            modal.style.display = 'flex';

            // Fetch deposit/QR data immediately
            try {
                const formData = new FormData();
                formData.append('Amount', amountInput.value);
                formData.append('CustomerName', document.querySelector('[name="CustomerName"]')?.value || '');
                formData.append('CustomerEmail', document.querySelector('[name="CustomerEmail"]')?.value || '');

                const token = document.querySelector('input[name="__RequestVerificationToken"]');
                if (token) formData.append('__RequestVerificationToken', token.value);

                const resp = await fetch('/Paysolutions/CreateDeposit', {
                    method: 'POST',
                    headers: { 'X-Requested-With': 'XMLHttpRequest' },
                    credentials: 'same-origin',
                    body: formData
                });

                if (!resp.ok) throw new Error('HTTP ' + resp.status);

                const text = await resp.text();
                let data;
                try {
                    data = JSON.parse(text);
                } catch {
                    throw new Error('Invalid JSON from server');
                }

                if (data.success && data.data) {
                    // Populate and show data in modal
                    document.getElementById('paysolutions-image').src = data.data.image;
                    document.getElementById('paysolutions-orderNo').textContent = data.data.orderNo;
                    document.getElementById('paysolutions-referenceNo').textContent = data.data.referenceNo;
                    document.getElementById('paysolutions-total').textContent = data.data.total;
                    document.getElementById('paysolutions-orderdatetime').textContent = data.data.orderdatetime;
                    document.getElementById('paysolutions-expiredate').textContent = data.data.expiredate;

                    if (messageContainer) messageContainer.style.display = 'none';
                    if (dataContainer) dataContainer.style.display = 'block';

                    // Enable OK to close and return to main view
                    newOkBtn.disabled = false;
                    newOkBtn.textContent = 'Done';
                    newOkBtn.onclick = () => {
                        modal.style.display = 'none';
                        // Reset for next time
                        if (dataContainer) dataContainer.style.display = 'none';
                        if (messageContainer) {
                            messageContainer.textContent = 'Generating Paysolutions QR... Please wait.';
                            messageContainer.style.display = 'none';
                        }
                    };
                } else {
                    // Show error in the modal
                    if (messageContainer) {
                        messageContainer.textContent = data.error || 'Paysolutions payment failed. Please try again.';
                        messageContainer.style.display = 'block';
                    }
                    newOkBtn.disabled = false;
                    newOkBtn.textContent = 'Done';
                    newOkBtn.onclick = () => { modal.style.display = 'none'; };
                }
            } catch (err) {
                console.error('Paysolutions payment error', err);
                if (messageContainer) {
                    messageContainer.textContent = 'Network error during Paysolutions payment. Please try again.';
                    messageContainer.style.display = 'block';
                }
                newOkBtn.disabled = false;
                newOkBtn.textContent = 'Done';
                newOkBtn.onclick = () => { modal.style.display = 'none'; };
            }
        }

        // Carousel logic
        let paymentCarouselOffset = 0;
        let paymentCarouselItemWidth = 0;
        function initializeCarousel() {
            const track = document.querySelector('.carousel-track');
            if (!track) return;
            const firstItem = track.querySelector('.carousel-item');
            if (firstItem) {
                // Include gap estimate (match CSS gap .5rem = 8px)
                paymentCarouselItemWidth = firstItem.getBoundingClientRect().width + 8;
            } else {
                paymentCarouselItemWidth = 128; // fallback
            }
            paymentCarouselOffset = 0;
            track.style.transform = 'translateX(0px)';
        }
        function movePaymentCarousel(direction) {
            const track = document.querySelector('.carousel-track');
            const container = document.querySelector('.method-carousel');
            if (!track || !container) return;
            if (!paymentCarouselItemWidth) initializeCarousel();
            const items = track.querySelectorAll('.carousel-item');
            const containerWidth = container.getBoundingClientRect().width;
            const maxVisible = Math.floor(containerWidth / paymentCarouselItemWidth) || 1;
            const maxOffset = Math.max(0, (items.length - maxVisible) * paymentCarouselItemWidth);
            paymentCarouselOffset += direction * paymentCarouselItemWidth;
            if (paymentCarouselOffset < 0) paymentCarouselOffset = 0;
            if (paymentCarouselOffset > maxOffset) paymentCarouselOffset = maxOffset;
            track.style.transform = 'translateX(' + (-paymentCarouselOffset) + 'px)';
        }
        // Expose globally for inline onclick handlers
        window.movePaymentCarousel = movePaymentCarousel;
        window.handlePayPalPayment = handlePayPalPayment;
        window.handleJMFPayment = handleJMFPayment;
        window.handleLuxtakPayment = handleLuxtakPayment;
        window.handleSmilepayzPayment = handleSmilepayzPayment;
        window.handlePaysolutionsPayment = handlePaysolutionsPayment;
        window.handleApplePayNuveiIFrame = handleApplePayNuveiIFrame;
        window.showLuxtakModal = showLuxtakModal;
        window.initializeCarousel = initializeCarousel;
        
        // SwiftGoldPay helpers (render QR + status)
        function renderSwiftGoldPayDepositResult(apiResponse) {
            try {
                const payload = apiResponse?.data?.data || apiResponse?.data || {};
                const b64 = payload.base64 || payload.qr_base64 || payload.qrImageBase64 || '';
                const refNo = payload.ref_no || payload.refNo || '';
                const resultWrap = document.getElementById('SwiftGoldPayResult');
                const img = document.getElementById('SwiftGoldPayQr');
                const refSpan = document.getElementById('SwiftGoldPayRefValue');
                const errEl = document.getElementById('SwiftGoldPayStatusError');
                const tableWrap = document.getElementById('SwiftGoldPayStatusTableWrap');
                if (!resultWrap || !img) return;
                if (b64) {
                    img.src = 'data:image/png;base64,' + b64;
                } else {
                    img.removeAttribute('src');
                }
                if (refSpan) refSpan.textContent = refNo || '-';
                resultWrap.style.display = 'block';
                window._sgpLastRefNo = refNo;
                window._sgpLastCurrency = (document.querySelector('[name="SwiftGoldPayCurrency"]')?.value) || 'THB';
                if (errEl) { errEl.style.display = 'none'; errEl.textContent = ''; }
                if (tableWrap) { tableWrap.style.display = 'none'; const tbody = document.querySelector('#SwiftGoldPayStatusTable tbody'); if (tbody) tbody.innerHTML = ''; }
                const btn = document.getElementById('SwiftGoldPayCheckStatusBtn');
                if (btn && !btn._sgpBound) {
                    btn.addEventListener('click', checkSwiftGoldPayStatus);
                    btn._sgpBound = true;
                }
            } catch (e) {
                const err = document.getElementById('SwiftGoldPayStatusError');
                if (err) { err.style.display = 'block'; err.textContent = 'Failed to render deposit result: ' + (e.message||''); }
            }
        }

        async function checkSwiftGoldPayStatus() {
            const errEl = document.getElementById('SwiftGoldPayStatusError');
            const tableWrap = document.getElementById('SwiftGoldPayStatusTableWrap');
            const tbody = document.querySelector('#SwiftGoldPayStatusTable tbody');
            try {
                const token = window._sgpToken;
                const refNo = window._sgpLastRefNo;
                const currency = window._sgpLastCurrency || 'THB';
                if (!token || !refNo) {
                    if (errEl) { errEl.style.display = 'block'; errEl.textContent = 'Missing token or reference number.'; }
                    return;
                }
                if (errEl) { errEl.style.display = 'none'; errEl.textContent = ''; }
                const url = `/SwiftGoldPay/TxStatus?token=${encodeURIComponent(token)}&refNo=${encodeURIComponent(refNo)}&currency=${encodeURIComponent(currency)}`;
                const resp = await fetch(url, { method: 'GET', credentials: 'same-origin' });
                const data = await resp.json();
                if (!data.success) {
                    if (errEl) { errEl.style.display = 'block'; errEl.textContent = data.error || 'Failed to get the deposit status!'; }
                    if (tableWrap) tableWrap.style.display = 'none';
                    return;
                }
                const items = data.items || [];
                renderSwiftGoldPayStatusTable(items);
            } catch (e) {
                if (errEl) { errEl.style.display = 'block'; errEl.textContent = 'Failed to get the deposit status! ' + (e.message||''); }
                if (tableWrap) tableWrap.style.display = 'none';
            }
        }

        function renderSwiftGoldPayStatusTable(items) {
            const tableWrap = document.getElementById('SwiftGoldPayStatusTableWrap');
            const tbody = document.querySelector('#SwiftGoldPayStatusTable tbody');
            if (!tbody || !tableWrap) return;
            tbody.innerHTML = '';
            try {
                items.forEach(it => {
                    const tr = document.createElement('tr');
                    const uid = (it?.uid ?? '').toString();
                    const ref_no = (it?.ref_no ?? it?.refNo ?? '').toString();
                    const amount = (it?.amount ?? '').toString();
                    const currency = (it?.currency ?? '').toString();
                    const process_type = (it?.process_type ?? it?.processType ?? '').toString();
                    const status = (it?.status ?? '').toString();
                    tr.innerHTML = `<td>${escapeHtml(uid)}</td>`+
                                   `<td>${escapeHtml(ref_no)}</td>`+
                                   `<td>${escapeHtml(amount)}</td>`+
                                   `<td>${escapeHtml(currency)}</td>`+
                                   `<td>${escapeHtml(process_type)}</td>`+
                                   `<td>${escapeHtml(status)}</td>`;
                    tbody.appendChild(tr);
                });
                tableWrap.style.display = items.length ? 'block' : 'none';
            } catch (e) {
                const err = document.getElementById('SwiftGoldPayStatusError');
                if (err) { err.style.display = 'block'; err.textContent = 'Failed to render status table: ' + (e.message||''); }
                tableWrap.style.display = 'none';
            }
        }

        // Nuvei Simply Connect Implementation
        let nuveiSimplyConnectSessionActive = false;

        // Intercept form submission for Nuvei Simply Connect
        const paymentForm = document.querySelector('.payment-form');
        if (paymentForm) {
            paymentForm.addEventListener('submit', async function(e) {
                const selectedMethod = document.querySelector('input[name="PaymentMethod"]:checked')?.value;

                if (selectedMethod === 'nuvei-simply-connect') {
                    e.preventDefault();

                    // If session is already active, allow normal submission
                    if (nuveiSimplyConnectSessionActive) {
                        return true;
                    }

                    // Get the Nuvei form's amount and currency
                    const amount = document.querySelector('[name="NuveiSimplyConnectAmount"]')?.value;
                    const currency = document.querySelector('[name="NuveiSimplyConnectCurrency"]')?.value;

                    if (!amount || amount <= 0) {
                        alert('Please enter a valid amount');
                        return false;
                    }

                    if (!currency) {
                        alert('Please select a currency');
                        return false;
                    }

                    // Initiate Nuvei session
                    await initiateNuveiSimplyConnectSession(amount, currency);
                    return false;
                }
            });
        }

        async function initiateNuveiSimplyConnectSession(amount, currency) {
            // Show loading overlay
            const loadingOverlay = document.getElementById('loading-overlay');
            if (loadingOverlay) loadingOverlay.style.display = 'flex';

            // Hide the deposit button
            const depositBtn = document.getElementById('deposit-btn');
            if (depositBtn) {
                depositBtn.style.display = 'none';
            }

            try {
                console.log('Initiating Nuvei Simply Connect session for amount:', amount, 'currency:', currency);

                // Call backend to initiate session
                const formData = new FormData();
                formData.append('amount', amount);
                formData.append('currency', currency);
                formData.append('__RequestVerificationToken', document.querySelector('input[name="__RequestVerificationToken"]').value);

                console.log('Sending openOrder request to /Nuvei/SimplyConnect/OpenOrder');
                const response = await fetch('/Nuvei/SimplyConnect/OpenOrder', {
                    method: 'POST',
                    body: formData
                });

                const data = await response.json();
                console.log('OpenOrder response:', data);

                if (data.success && data.sessionToken) {
                    console.log('Session initiated successfully, sessionToken:', data.sessionToken.substring(0, 20) + '...');
                    console.log('Client Unique ID:', data.clientUniqueId);
                    
                    // Store session data
                    document.getElementById('nuvei-session-token').value = data.sessionToken;
                    document.getElementById('nuvei-merchant-id').value = data.merchantId;
                    document.getElementById('nuvei-merchant-site-id').value = data.merchantSiteId;
                    document.getElementById('nuvei-order-id').value = data.orderId;

                    // Hide loading overlay before initializing checkout
                    if (loadingOverlay) loadingOverlay.style.display = 'none';
                    
                    // Show the checkout div
                    const checkoutDiv = document.getElementById('nuvei-checkout');
                    if (checkoutDiv) checkoutDiv.style.display = 'flex';

                    // Initialize the checkout form
                    nuveiSimplyConnectSessionActive = true;
                    initializeNuveiCheckout(data.sessionToken, data.merchantId, data.merchantSiteId, amount, currency, data.clientUniqueId);
                } else {
                    // Hide loading overlay on error
                    if (loadingOverlay) loadingOverlay.style.display = 'none';
                    alert('Failed to initiate payment session: ' + (data.error || 'Unknown error'));
                    console.error('OpenOrder failed:', data);
                }
            } catch (error) {
                // Hide loading overlay on error
                if (loadingOverlay) loadingOverlay.style.display = 'none';
                console.error('Error initiating Nuvei checkout:', error);
                alert('Error initiating payment session: ' + error.message);
            }
        }

        function initializeNuveiCheckout(sessionToken, merchantId, merchantSiteId, amount, currency, clientUniqueId) {
            // Wait for checkout.js to be loaded
            if (typeof window.checkout === 'undefined') {
                console.log('Waiting for checkout.js to load...');
                setTimeout(() => initializeNuveiCheckout(sessionToken, merchantId, merchantSiteId, amount, currency, clientUniqueId), 500);
                return;
            }

            const checkoutContainer = document.getElementById('nuvei-checkout');
            checkoutContainer.innerHTML = '<p style="color: #999;">Loading payment methods...</p>';
            checkoutContainer.style.display = 'flex';

            const amount_str = amount.toString();

            // Call the checkout() method with configuration
            try {
                console.log('Calling window.checkout() with sessionToken:', sessionToken.substring(0, 20) + '...');
                
                window.checkout({
                    sessionToken: sessionToken,
                    merchantSiteId: merchantSiteId,
                    merchantId: merchantId,
                    country: "US",
                    currency: currency,
                    amount: amount_str,
                    renderTo: "#nuvei-checkout",
                    env: "int",

                    onReady: function(result) {
                        console.log('Nuvei checkout ready:', result);
                    },

                    onSelectPaymentMethod: function(paymentDetails) {
                        console.log('Payment method selected:', paymentDetails);
                    },

                    onPaymentEvent: function(result) {
                        console.log('Payment event:', result);
                    },

                    onResult: function(result) {
                        console.log('Nuvei checkout result:', result);
                        
                        // Call getPaymentStatus to get the full transaction details
                        if (result.transactionId) {
                            getPaymentStatus(result.transactionId, result);
                        } else {
                            handlePaymentResult(result);
                        }
                    },

                    // Payment form customization
                    disableDeclineRecovery: false,
                    savePM: "true",
                    showCardLogos: true,
                    alwaysCollectCvv: "true",
                    maskCvv: true,
                    locale: "en",
                    textDirection: "ltr",
                    theme: "tiles"
                });
            } catch (error) {
                console.error('Error initializing Nuvei checkout:', error);
                checkoutContainer.innerHTML = '<p style="color: #d00;">Error loading payment form: ' + error.message + '</p>';
            }
        }

        async function getPaymentStatus(transactionId, checkoutResult) {
            console.log('Fetching payment status for transactionId:', transactionId);
            try {
                const formData = new FormData();
                formData.append('transactionId', transactionId);
                formData.append('__RequestVerificationToken', document.querySelector('input[name="__RequestVerificationToken"]').value);

                const response = await fetch('/Nuvei/SimplyConnect/GetPaymentStatus', {
                    method: 'POST',
                    body: formData
                });

                const data = await response.json();
                console.log('Payment status response:', data);

                if (data.success) {
                    displayPaymentResult(data);
                } else {
                    console.error('Failed to get payment status:', data.error);
                    handlePaymentResult(checkoutResult);
                }
            } catch (error) {
                console.error('Error getting payment status:', error);
                handlePaymentResult(checkoutResult);
            }
        }

        function displayPaymentResult(statusData) {
            const checkoutDiv = document.getElementById('nuvei-checkout');
            
            const resultHtml = `
                <div style="width: 100%; padding: 20px; background: white; border-radius: 8px;">
                    <div style="text-align: center; margin-bottom: 20px;">
                        <h2 style="margin: 0 0 10px 0; color: #333;">Transaction Result</h2>
                    </div>
                    
                    <div style="background: #f8f9ff; padding: 16px; border-radius: 6px; border-left: 4px solid #667eea;">
                        <div style="display: flex; justify-content: space-between; padding: 8px 0; border-bottom: 1px solid #e0e0e0;">
                            <span style="font-weight: 600; color: #666;">Transaction Status</span>
                            <span style="color: ${statusData.transactionStatus === 'APPROVED' ? '#22c55e' : '#ef4444'}; font-weight: 600;">${statusData.transactionStatus || 'UNKNOWN'}</span>
                        </div>
                        
                        <div style="display: flex; justify-content: space-between; padding: 8px 0; border-bottom: 1px solid #e0e0e0;">
                            <span style="font-weight: 600; color: #666;">Transaction ID</span>
                            <span style="color: #333; font-family: monospace;">${statusData.transactionId || 'N/A'}</span>
                        </div>
                        
                        <div style="display: flex; justify-content: space-between; padding: 8px 0; border-bottom: 1px solid #e0e0e0;">
                            <span style="font-weight: 600; color: #666;">Amount</span>
                            <span style="color: #333; font-weight: 600;">${statusData.amount || 'N/A'} ${statusData.currency || ''}</span>
                        </div>
                        
                        <div style="display: flex; justify-content: space-between; padding: 8px 0; border-bottom: 1px solid #e0e0e0;">
                            <span style="font-weight: 600; color: #666;">Client Unique ID</span>
                            <span style="color: #333; font-family: monospace; word-break: break-all;">${statusData.clientUniqueId || 'N/A'}</span>
                        </div>
                        
                        <div style="display: flex; justify-content: space-between; padding: 8px 0; border-bottom: 1px solid #e0e0e0;">
                            <span style="font-weight: 600; color: #666;">Error Code</span>
                            <span style="color: #333;">${statusData.gwErrorCode !== undefined && statusData.gwErrorCode !== 0 ? statusData.gwErrorCode : 'N/A'}</span>
                        </div>
                        
                        <div style="display: flex; justify-content: space-between; padding: 8px 0; border-bottom: 1px solid #e0e0e0;">
                            <span style="font-weight: 600; color: #666;">Extended Error Code</span>
                            <span style="color: #333;">${statusData.gwExtendedErrorCode !== undefined && statusData.gwExtendedErrorCode !== 0 ? statusData.gwExtendedErrorCode : 'N/A'}</span>
                        </div>
                        
                        <div style="display: flex; justify-content: space-between; padding: 8px 0;">
                            <span style="font-weight: 600; color: #666;">Error Message</span>
                            <span style="color: #333;">${statusData.gwErrorReason || 'N/A'}</span>
                        </div>
                    </div>
                    
                    <div style="display: flex; gap: 12px; margin-top: 20px;">
                        <button onclick="location.href='/Payment'" style="flex: 1; padding: 10px; background: #667eea; color: white; border: none; border-radius: 6px; cursor: pointer; font-weight: 600;">Make Another Payment</button>
                        <button onclick="location.href='/'" style="flex: 1; padding: 10px; background: #f0f0f0; color: #333; border: none; border-radius: 6px; cursor: pointer; font-weight: 600;">Return Home</button>
                    </div>
                </div>
            `;
            
            checkoutDiv.innerHTML = resultHtml;
            checkoutDiv.style.display = 'flex';
            checkoutDiv.style.flexDirection = 'column';
            checkoutDiv.style.alignItems = 'center';
            checkoutDiv.style.justifyContent = 'flex-start';
            checkoutDiv.style.height = 'auto';
        }

        function handlePaymentResult(result) {
            if (result.transactionStatus === 'APPROVED') {
                console.log('Payment approved:', result);
                window.location.href = '/Payment/Success?transactionId=' + encodeURIComponent(result.transactionId || '');
            } else if (result.transactionStatus === 'DECLINED') {
                console.log('Payment declined:', result);
                alert('Payment was declined: ' + (result.errorDescription || result.errCode || 'Unknown error'));
            } else if (result.transactionStatus === 'ERROR') {
                console.log('Payment error:', result);
                alert('Payment error: ' + (result.errorDescription || result.errCode || 'Unknown error'));
            } else {
                console.log('Payment pending or other status:', result);
                alert('Payment status: ' + (result.transactionStatus || 'Unknown'));
            }
        }
    </script>
}