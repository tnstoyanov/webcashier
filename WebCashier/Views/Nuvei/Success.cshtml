@{
    ViewData["Title"] = "Payment Success";
    
    // Helper to get query parameter safely
    string Q(string k) => Context.Request.Query[k].FirstOrDefault() ?? string.Empty;
    
    // Extract all relevant fields
    var transactionId = Q("TransactionID");
    var pppTransactionId = Q("PPP_TransactionID");
    var status = Q("Status");
    var amount = string.IsNullOrWhiteSpace(Q("totalAmount")) ? Q("total_amount") : Q("totalAmount");
    var currency = Q("currency");
    var merchantRef = Q("merchant_unique_id");
    var clientId = Q("ClientUniqueID");
    var paymentMethod = Q("payment_method");
    var authCode = Q("AuthCode");
    var cardBrand = Q("cardBrand");
    var issuer = Q("issuerName");
    var timestamp = Q("responseTimeStamp");
    
    // Determine if we have a successful transaction
    var isSuccessful = !string.IsNullOrWhiteSpace(transactionId) && 
                       (string.Equals(status, "APPROVED", StringComparison.OrdinalIgnoreCase) || 
                        string.Equals(status, "SUCCESS", StringComparison.OrdinalIgnoreCase));
}

<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>@ViewData["Title"]</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Roboto', 'Oxygen', 'Ubuntu', 'Cantarell', sans-serif; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); min-height: 100vh; display: flex; align-items: center; justify-content: center; padding: 20px; }
        .container { max-width: 600px; width: 100%; }
        .success-card { background: white; border-radius: 12px; box-shadow: 0 20px 60px rgba(0,0,0,0.3); overflow: hidden; }
        .success-header { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 40px 20px; text-align: center; position: relative; }
        .success-icon { width: 80px; height: 80px; margin: 0 auto 20px; background: rgba(255,255,255,0.2); border-radius: 50%; display: flex; align-items: center; justify-content: center; animation: scaleIn 0.6s ease-out; }
        .success-icon svg { width: 45px; height: 45px; stroke: white; stroke-width: 2; }
        .success-header h1 { font-size: 28px; margin-bottom: 8px; font-weight: 600; }
        .success-header p { font-size: 14px; opacity: 0.9; }
        .success-body { padding: 40px 30px; }
        .transaction-detail { display: flex; justify-content: space-between; padding: 12px 0; border-bottom: 1px solid #f0f0f0; font-size: 14px; }
        .transaction-detail:last-child { border-bottom: none; }
        .detail-label { font-weight: 600; color: #666; }
        .detail-value { color: #333; font-family: 'Courier New', monospace; }
        .detail-value.highlight { font-weight: 600; color: #667eea; }
        .amount-display { background: #f8f9ff; border-left: 4px solid #667eea; padding: 16px; margin: 20px 0; border-radius: 4px; }
        .amount-display .label { font-size: 12px; color: #999; text-transform: uppercase; margin-bottom: 4px; }
        .amount-display .value { font-size: 28px; font-weight: 700; color: #333; }
        .action-buttons { display: flex; gap: 12px; margin-top: 30px; }
        .btn { flex: 1; padding: 12px 20px; border: none; border-radius: 6px; font-size: 14px; font-weight: 600; cursor: pointer; text-decoration: none; text-align: center; transition: all 0.2s; }
        .btn-primary { background: #667eea; color: white; }
        .btn-primary:hover { background: #5568d3; }
        .btn-secondary { background: #f0f0f0; color: #333; }
        .btn-secondary:hover { background: #e0e0e0; }
        .empty-state { text-align: center; padding: 40px 20px; }
        .empty-state svg { width: 80px; height: 80px; margin-bottom: 20px; opacity: 0.5; }
        .empty-state h2 { font-size: 18px; color: #333; margin-bottom: 10px; }
        .empty-state p { color: #999; font-size: 14px; margin-bottom: 20px; }
        @@keyframes scaleIn { from { transform: scale(0.8); opacity: 0; } to { transform: scale(1); opacity: 1; } }
        @@media (max-width: 600px) {
            .success-header { padding: 30px 15px; }
            .success-body { padding: 25px 15px; }
            .success-header h1 { font-size: 24px; }
            .amount-display .value { font-size: 24px; }
        }
    </style>
</head>
<body>
    <script>
        // Break out of iframe if loaded inside one
        // This happens when Nuvei redirects to Success/Error/Pending within the Apple Pay iframe
        (function() {
            try {
                // Check if we're inside an iframe
                if (window.self !== window.top) {
                    console.log('[Nuvei Success] Detected iframe. Breaking out and navigating parent window.');
                    // Build the current URL to navigate the parent window
                    var currentUrl = window.location.href;
                    // Navigate the parent (entire browser window) to this URL
                    window.top.location.href = currentUrl;
                }
            } catch (e) {
                console.error('[Nuvei Success] Error checking iframe:', e);
                // Proceed normally if there's any error
            }
        })();
    </script>
    <div class="container">
        @if (isSuccessful)
        {
            <div class="success-card">
                <div class="success-header">
                    <div class="success-icon">
                        <svg viewBox="0 0 24 24" fill="none"><path d="M20 6L9 17l-5-5" stroke-linecap="round" stroke-linejoin="round"/></svg>
                    </div>
                    <h1>Payment Successful!</h1>
                    <p>Your transaction has been completed.</p>
                </div>
                <div class="success-body">
                    @if (!string.IsNullOrWhiteSpace(amount) && !string.IsNullOrWhiteSpace(currency))
                    {
                        <div class="amount-display">
                            <div class="label">Amount Charged</div>
                            <div class="value">@amount <span style="font-size: 20px;">@currency</span></div>
                        </div>
                    }
                    
                    <div class="transaction-detail">
                        <span class="detail-label">Status</span>
                        <span class="detail-value highlight">@(string.IsNullOrWhiteSpace(status) ? "APPROVED" : status)</span>
                    </div>
                    
                    @if (!string.IsNullOrWhiteSpace(transactionId))
                    {
                        <div class="transaction-detail">
                            <span class="detail-label">Transaction ID</span>
                            <span class="detail-value">@transactionId</span>
                        </div>
                    }
                    
                    @if (!string.IsNullOrWhiteSpace(pppTransactionId))
                    {
                        <div class="transaction-detail">
                            <span class="detail-label">PPP Transaction ID</span>
                            <span class="detail-value">@pppTransactionId</span>
                        </div>
                    }
                    
                    @if (!string.IsNullOrWhiteSpace(clientId))
                    {
                        <div class="transaction-detail">
                            <span class="detail-label">Client ID</span>
                            <span class="detail-value">@clientId</span>
                        </div>
                    }
                    
                    @if (!string.IsNullOrWhiteSpace(merchantRef))
                    {
                        <div class="transaction-detail">
                            <span class="detail-label">Merchant Reference</span>
                            <span class="detail-value">@merchantRef</span>
                        </div>
                    }
                    
                    @if (!string.IsNullOrWhiteSpace(paymentMethod))
                    {
                        <div class="transaction-detail">
                            <span class="detail-label">Payment Method</span>
                            <span class="detail-value">@paymentMethod</span>
                        </div>
                    }
                    
                    @if (!string.IsNullOrWhiteSpace(cardBrand))
                    {
                        <div class="transaction-detail">
                            <span class="detail-label">Card Brand</span>
                            <span class="detail-value">@cardBrand</span>
                        </div>
                    }
                    
                    @if (!string.IsNullOrWhiteSpace(authCode))
                    {
                        <div class="transaction-detail">
                            <span class="detail-label">Auth Code</span>
                            <span class="detail-value">@authCode</span>
                        </div>
                    }
                    
                    @if (!string.IsNullOrWhiteSpace(timestamp))
                    {
                        <div class="transaction-detail">
                            <span class="detail-label">Timestamp</span>
                            <span class="detail-value">@timestamp</span>
                        </div>
                    }
                    
                    <div class="action-buttons">
                        <a href="/Payment" class="btn btn-primary">Make Another Payment</a>
                        <a href="/" class="btn btn-secondary">Return Home</a>
                    </div>
                </div>
            </div>
        }
        else
        {
            <div class="success-card">
                <div class="empty-state">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor"><circle cx="12" cy="12" r="10"/><line x1="12" y1="8" x2="12" y2="12"/><line x1="12" y1="16" x2="12.01" y2="16"/></svg>
                    <h2>No Transaction Data</h2>
                    <p>We couldn't find the transaction details. Please check your transaction ID or go back to try again.</p>
                    <a href="/Payment" class="btn btn-primary" style="margin-top: 20px; display: inline-block; width: auto; padding: 10px 30px;">Return to Payment</a>
                </div>
            </div>
        }
    </div>
</body>
</html>
